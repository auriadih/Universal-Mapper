<!-- {% import "bootstrap/utils.html" as utils %} -->

{% extends "base.html" %}

{% block title %}Etusivu{% endblock %}

{% block sisältö %}
<div class="content-section">
  <div class="contents">
    {% if current_user.is_authenticated %}

      <!-- Modal for automatically mapped term info -->
      <div id="acceptModal" class="modal" tabIndex='-1' role="dialog">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <div class="modal-title" id="mapped-title">Hyväksy automaattinen siltaus</div>
            </div>
            <div class="modal-body" id="mapped-content">
              <div class="help-text">
                <p>Virallisesta siltaustiedostosta löytyy yksi tai useita vastineita alkuperäiselle konseptille, jota olet siltaamassa. Valitse näistä sopivin kohdekonsepti ("Kohdekoodi" ja "Kohdetermi" -pari). Voit lisäksi valita alemmasta taulukosta muita alkuperäisen (organisaatiosi) koodiston konsepteja ja sillata ne samaan valitsemaasi kohdekonseptiin.</p>
              </div>
              <div id="bridge-title"><h5>Virallisesta koodiston siltauksesta löytyvät vastineet:</h5></div>
              <table id='bridge_concepts' class='table table-hover table-sm'>
                <thead class='thead-light'>
                  <tr><th>Virallinen lähdekoodi</th><th>Virallinen lähdetermi</th><th>Virallinen kohdekoodi</th><th>Virallinen kohdetermi</th></tr>
                </thead>
                <tbody> <!-- populated with jQuery --> </tbody>
              </table><br>
              <div id="similars-block">
                <h5>Samankaltaisia koodeja ja termejä alkuperäisessä (organisaatiosi) koodistossa:</h5>
                <table id='similar_concepts' class='table table-hover table-sm'>
                  <thead class='thead-light'>
                    <tr><th>Hylkää</th><th>Organisaatiosi koodi</th><th>Organisaatiosi termi</th><th>N</th><th>Sillattavan koodiston kohdekoodi</th><th>Sillattavan koodiston kohdetermi</th></tr>
                  </thead>
                  <tbody> <!-- populated with jQuery --> </tbody>
                </table>
                <h5>Valitse alemmasta taulukosta ne konseptit, jotka haluat liittää ylemmän taulukon sillattavaan kohdekonseptiin.</h5>
              </div>
              <div class="selected-original-term"><h5>Olet siltaamassa organisaatiosi konseptia: <span class="dynamic-original-term"></span><span class="dynamic-original-term-desc"></span><span class="dynamic-original-term-n"></span></h5></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-success disabled" id="btn-hyväksy">Hyväksy siltaus</button>
              <button type="button" class="btn btn-warning disabled" id="btn-manuaalinen">Manuaalinen haku</button>
              <button type="button" class="btn btn-secondary" data-dismiss="modal" id="btn-sulje">Sulje</button>
            </div>
          </div>
        </div>
      </div>



      <!-- Modal for term rejection info -->
      <div id="rejectModal" class="modal" tabIndex='-1' role="dialog">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <div class="modal-title" id="reject-title">Termin hylkäys</div>
            </div>
            <div class="modal-body" id="reject-content">
              <h5>Anna selite miksi konseptia ei voida sillata</h5>
              <textarea name="Selite" id="hylkäys-syy" cols="80" rows="7"></textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-success disabled" id="btn-reject">Hylkää konsepti</button>
              <button type="button" class="btn btn-secondary" data-dismiss="modal" id="btn-reject-reject">Sulje</button>
            </div>
          </div>
        </div>
      </div>



      <!-- Modal for mapped concept info -->
      <div id="mappedModal" class="modal" tabIndex='-1' role="dialog">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <div class="modal-title" id="mapping-title">Käyttäjän tekemä siltaus</div>
            </div>
            <div class="modal-body" id="mapping-content">
              <div class="row">
                <div class="col-md-12">
                  <div id="mapped-concept-source-system"></div>
                  <div id="mapped-concept-source"></div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12">
                  <div id="mapped-concept-target-system"></div>
                  <div id="mapped-concept-target"></div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12">
                  <h4>Siltaustiedot:</h4><br>
                  <div id="mapper-detailed-info"></div>
                  <h4>Historia:</h4><br>
                  <div id="mapped-concept-history"></div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-warning" id="btn-change-mapping">Muokkaa siltausta</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal" id="btn-close">Sulje</button>
            </div>
          </div>
        </div>
      </div>



      <!-- navigation tabs -->
      <nav class="navbar navbar-expand-lg navbar-light">
        <div class="collapse navbar-collapse">

          <!-- Original terms tabs -->
          <ul class="nav nav-tabs mr-auto" role="tablist" id="original-tabs">
            <li class="nav-item active"><a href="#original-tab" class="nav-link active show" data-toggle="tab" aria-expand="true">{% if source %}{{ source }}{% else %}Alkuperäinen koodisto{% endif %}</a></li>
            <li class="nav-item"><a href="#novel-tab" class="nav-link" data-toggle="tab" aria-expand="true">{% if target %}{{ target }}{% else %}Uusi koodisto{% endif %}</a></li>
          </ul>
        </div>
      </nav>



      <div class="tab-content">

        <!-- Original term tab -->
        <div class="tab-pane active" id="original-tab">

          <!-- Loading animation -->
          <div class="loader">
            <div class="center spinner" id="loading-animation"></div>
          </div>

          <!-- table container -->
          <div class="original-placeholder">
            <div class="help-text">
              <p>Alla olevassa taulukossa näet organisaatiossasi käytössä olevat ja olleet 'koodi + termi' parit (konseptit). Konseptille näytetään niiden volyymi organisaatiossasi (N) ja aikajakso jolloin kyseinen konsepti on ollut käytössä, mikäli tiedot ovat olleet saatavissa.</p>
            </div>

            <!-- Filtering buttons -->
            <nav class="navbar navbar-expand-lg navbar-light">
              <div class="collapse navbar-collapse justify-content-end">
                <ul class="navbar-nav" id="filtering-buttons">
                  <li class="nav-item"><button type="button" class="btn btn-sm btn-light" id="filter-table-light">Siltaamattomat</button></li>
                  <li class="nav-item"><button type="button" class="btn btn-sm btn-secondary" id="filter-table-secondary">Hyväksyttävät</button></li>
                  <li class="nav-item"><button type="button" class="btn btn-sm btn-danger" id="filter-table-danger">Hylätyt</button></li>
                  <li class="nav-item"><button type="button" class="btn btn-sm btn-info" id="filter-table-info">Toinen organisaatio</button></li>
                  <li class="nav-item"><button type="button" class="btn btn-sm btn-primary" id="filter-table-primary">Oma organisaatio</button></li>
                  <li class="nav-item"><button type="button" class="btn btn-sm btn-success" id="filter-table-success">Omat siltaukset</button></li>
                </ul>
              </div>
            </nav>

            <table id="original" class="table table-hover table-sm">
              <thead class="thead-light">
                <tr>
                  <th>Hylkää</th><th>Koodi</th><th>Termi</th><th>N</th><th>Alkaen</th><th>Asti</th><th>Status</th><th>Konsepti</th>
                </tr>
              </thead>
              <tbody>
                {% for original in originals %}
                  <tr class="table-light">
                    <td class="hylkää"><img src="{{ url_for('static', filename='images/Stop_hand_caution.svg') }}" class='scaled-icon stop' alt='N/A' id='stop-sign'><div class="img-loader"><div class="center img-spinner" id="image-loading-animation"></div></div></td>
                    <td class="oldcode">{{ original.code_text }}</td>
                    <td class="oldterm">{{ original.term_text }}</td>
                    <td class="n">{{ original.obs_number }}</td>
                    <td class="alkaen">{{ original.first_obs_date }}</td>
                    <td class="asti">{{ original.last_obs_date }}</td>
                    <td class="status">{{ original.status_text }}</td>
                    <td class="concept-id">{{ original.concept_id }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="progress" id="progress-concepts">
            <div class="progress-bar bg-secondary" id="progress-bridged" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
            <div class="progress-bar bg-danger" id="progress-rejected" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
            <div class="progress-bar bg-info" id="progress-other" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
            <div class="progress-bar bg-primary" id="progress-user-organisation" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
            <div class="progress-bar bg-success" id="progress-user" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
            <div id="progress-text"><p>Sillattu <span id="progress-mapped"></span> / <span id="progress-total"></span> konseptia</p></div>
          </div>
          <div class="progress" id="progress-samples">
            <div class="progress-bar progress-bar-striped bg-secondary" id="progress-bridged-sample" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
            <div class="progress-bar progress-bar-striped bg-danger" id="progress-rejected-sample" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
            <div class="progress-bar progress-bar-striped bg-info" id="progress-other-sample" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
            <div class="progress-bar progress-bar-striped bg-primary" id="progress-user-organisation-sample" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
            <div class="progress-bar progress-bar-striped bg-success" id="progress-user-sample" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
            <div id="progress-text-sample"><p>Sillattu <span id="progress-mapped-sample"></span> / <span id="progress-total-sample"></span> näytettä</p></div>
          </div>
        </div>



        <!-- Novel term tab -->
        <div class="tab-pane" id="novel-tab">
          <!-- Loading animation -->
          <div class="novel-loader">
            <div class="center spinner" id="loading-animation"></div>
          </div>

          <div class="novel-placeholder">
            <div class="help-text">
              <p>Alkuperäiselle konseptille, jota olet siltaamassa ei löytynyt vastaavuuksia muista organisaatioista. Valitse alla olevasta taulukosta se kohdekonsepti ("Uusi koodi" ja "Uusi termi" -pari), joka mielestäsi vastaa organisaatiossasi käytettyä konseptia, jota olet siltaamassa.</p>
              <p>Taulukossa esitetyt vanhan koodiston konseptit ovat kohdekonseptiin sillattuja virallisen koodiston konsepteja, <u>eivät organisaatiosi konsepteja</u>.</p>
              <p>Voit myös etsiä manuaalisesti sopivaa kohdekonseptia käyttämällä IHTSDO:n upotettua selainta.</p>
            </div>
            <table id="novel" class="table table-hover table-sm">
              <thead class="thead-light">
                <tr>
                  <th>Vanha koodi</th><th>Vanha termi</th><th>Vanha murre</th><th>Vanha konsepti</th><th>Uusi koodi</th><th>Uusi termi</th><th>Uusi murre</th><th>Uusi konsepti</th>
                </tr>
              </thead>
              <tbody> <!-- populated with jQuery --> </tbody>
            </table>



            <!-- embedded external components -->
            {% if target == 'Snomed CT' %}
              <div class="row" id="embedded-externals">
                <div class="col-sm-12">
                  <nav class="navbar navbar-expand-lg navbar-light">
                    <div class="collapse navbar-collapse">

                      <!-- Browser tabs -->
                      <ul class="nav nav-tabs mr-auto" role="tablist" id="ihtsdo-tabs">
                        <!-- <li class="nav-item"><a href="#neo4j-visu-tab" class="nav-link" data-toggle="tab" aria-expand="true">NEO4J</a></li> -->
                        <li class="nav-item"><a href="#ihtsdo-taxonomy-tab" class="nav-link" data-toggle="tab" aria-expand="true">Taxonomy</a></li>
                        <li class="nav-item active"><a href="#ihtsdo-details-tab" class="nav-link active show" data-toggle="tab" aria-expand="true">Details</a></li>
                        <li class="nav-item"><a href="#ihtsdo-search-tab" class="nav-link" data-toggle="tab" aria-expand="true">Manual Search</a></li>
                      </ul>

                      <!-- Link to external browser -->
                      <ul class="navbar-nav" id="route-to-external-buttons">
                        <li class="nav-item"><a id="ihtsdo_browser_link" target='_blank'><button type="button" class="btn btn-light" id="goto-external-browser">IHTSDO Browser (external)</button></a></li>
                      </ul>
                    </div>
                  </nav>

                  <div id="ihtsdo_browser" class="ihtsdo-browser">
                    <div class="tab-content">
                      <!-- NOTE: not yet implemented -->
                      <!-- <div class="tab-pane" id="neo4j-visu-tab"><div id="graphdb-viz"></div></div> -->
                      <div class="tab-pane" id="ihtsdo-taxonomy-tab"><div id="ihtsdo-taxonomy"></div></div>
                      <div class="tab-pane active" id="ihtsdo-details-tab"><div id="ihtsdo-details"></div></div>
                      <div class="tab-pane" id="ihtsdo-search-tab"><div id="ihtsdo-search"></div></div>
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}



            <div id="novel-similars-block">
              <h5>Samankaltaisia koodeja ja termejä alkuperäisessä (organisaatiosi) koodistossa:</h5>
              <table id='novel_similar_concepts' class='table table-hover table-sm'>
                <thead class='thead-light'>
                  <tr><th>Hylkää</th><th>Organisaatiosi koodi</th><th>Organisaatiosi termi</th><th>N</th></tr>
                </thead>
                <tbody> <!-- populated with jQuery --> </tbody>
              </table>
              <h5>Valitse näistä ne, jotka haluat liittää valittuun kohdekoodiston kohdekonseptiin.</h5>
            </div>



            <div class="row" id="save-buttons">
              <div class="selected-original-term"><h5>Olet siltaamassa organisaatiosi konseptia: <span class="dynamic-original-term"></span><span class="dynamic-original-term-desc"></span><span class="dynamic-original-term-n"></span></h5></div>
              <div class="col-sm-12">
                <button type="button" class="btn btn-secondary disabled" id="tallenna">Hyväksy siltaus</button>
                <button type="button" class="btn btn-danger" id="peru">Takaisin</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    <!-- Fallback if user is not logged in -->
    {% else %}
      <p>Kirjaudu sisään käyttääksesi sivuston toimintoja.</p>
    {% endif %}
  </div>
</div>






<script>
/* update progress bars */
function summarizeTable (table) {
  if (table) {
    var UserConcepts = table.rows('.table-success').count() || 0
    var UserOrgConcepts = table.rows('.table-primary').count() || 0
    var OtherConcepts = table.rows('.table-info').count() || 0
    var RejectedConcepts = table.rows('.table-danger').count() || 0
    var BridgedConcepts = table.rows('.table-secondary').count() || 0
    var TotalConcepts = table.rows().count() || 0
    var UserPercent = UserConcepts / TotalConcepts * 100 || 0
    var UserOrgPercent = UserOrgConcepts / TotalConcepts * 100 || 0
    var OtherPercent = OtherConcepts / TotalConcepts * 100 || 0
    var RejectedPercent = RejectedConcepts / TotalConcepts * 100 || 0
    var BridgedPercent = BridgedConcepts / TotalConcepts * 100 || 0
    if (table.column(3).data()) {
      var UserSamples = table.cells('.table-success', 3).data().reduce((a, b) => Number(a) + Number(b), 0)
      var UserOrgSamples = table.cells('.table-primary', 3).data().reduce((a, b) => Number(a) + Number(b), 0)
      var OtherSamples = table.cells('.table-info', 3).data().reduce((a, b) => Number(a) + Number(b), 0)
      var RejectedSamples = table.cells('.table-danger', 3).data().reduce((a, b) => Number(a) + Number(b), 0)
      var BridgedSamples = table.cells('.table-secondary', 3).data().reduce((a, b) => Number(a) + Number(b), 0)
      var TotalSamples = table.column(3).data().reduce((a, b) => Number(a) + Number(b), 0)
      var UserSamplePercent = UserSamples / TotalSamples * 100 || 0
      var UserOrgSamplePercent = UserOrgSamples / TotalSamples * 100 || 0
      var OtherSamplePercent = OtherSamples / TotalSamples * 100 || 0
      var RejectedSamplePercent = RejectedSamples / TotalSamples * 100 || 0
      var BridgedSamplePercent = BridgedSamples / TotalSamples * 100 || 0
    }

    $('#progress-user').attr('aria-valuenow', UserPercent).css('width', UserPercent + '%')
    $('#progress-user-organisation').attr('aria-valuenow', UserOrgPercent).css('width', UserOrgPercent + '%')
    $('#progress-other').attr('aria-valuenow', OtherPercent).css('width', OtherPercent + '%')
    $('#progress-rejected').attr('aria-valuenow', RejectedPercent).css('width', RejectedPercent + '%')
    $('#progress-bridged').attr('aria-valuenow', BridgedPercent).css('width', BridgedPercent + '%')
    $('div#progress-text p span#progress-mapped').empty().append(UserConcepts + UserOrgConcepts + OtherConcepts + RejectedConcepts + BridgedConcepts)
    $('div#progress-text p span#progress-total').empty().append(TotalConcepts)

    $('#progress-user-sample').attr('aria-valuenow', UserSamplePercent).css('width', UserSamplePercent + '%')
    $('#progress-user-organisation-sample').attr('aria-valuenow', UserOrgSamplePercent).css('width', UserOrgSamplePercent + '%')
    $('#progress-other-sample').attr('aria-valuenow', OtherSamplePercent).css('width', OtherSamplePercent + '%')
    $('#progress-rejected-sample').attr('aria-valuenow', RejectedSamplePercent).css('width', RejectedSamplePercent + '%')
    $('#progress-bridged-sample').attr('aria-valuenow', BridgedSamplePercent).css('width', BridgedSamplePercent + '%')
    $('div#progress-text-sample p span#progress-mapped-sample').empty().append(UserSamples + UserOrgSamples + OtherSamples + RejectedSamples + BridgedSamples)
    $('div#progress-text-sample p span#progress-total-sample').empty().append(TotalSamples)
  }
}






/* invoke IHTSDO embedded external browser */
function launchEmbeddedBrowser (conceptId, options, tab) {
  /* update embedded IHTSDO browser */
  var Taxonomies = new taxonomyPanel(document.getElementById('ihtsdo-taxonomy'), conceptId, options)
  /* var ref = new refsetPanel(document.getElementById("div-3-id"), options) */
  var Details = new conceptDetails(document.getElementById('ihtsdo-details'), conceptId, options)
  var Search = new searchPanel(document.getElementById('ihtsdo-search'), options)
  Details.subscribe(Taxonomies)
  Taxonomies.subscribe(Search)
  Details.subscribe(Search)
  Details.setupCanvas()

  /* enrich embedded browsers navigation bar with suitable attributes to inherit styling */
  $('ul#details-tabs-ihtsdo-details.nav.nav-tabs').attr('role', 'tablist')
  $('ul#details-tabs-ihtsdo-details.nav.nav-tabs > li').attr('class', 'nav-item')
  $('ul#details-tabs-ihtsdo-details.nav.nav-tabs > li > a').attr('class', 'nav-link')

  /* make detail summary main element a bit wider */
  $('#home-attributes-ihtsdo-details.col-md-offset-1.col-md-4').removeClass('col-md-4').addClass('col-md-6')

  /* hide horizontal scroll bar which shouldn't be visible */
  $('.panel.panel-default').css('overflow-x', 'hidden')

  /* align all search options buttons */
  $('div#ihtsdo-search-searchConfigBar div').css('margin-top', '5px')

  /* update external browser link with selected Snomed-CT concept ID */
  $('#ihtsdo_browser_link').attr('href', 'http://browser.ihtsdotools.org/?perspective=full&conceptId1=' +
    $(this).find('td.conceptid').text() +
    '&edition=en-edition&release=v20180731&server=http://browser.ihtsdotools.org/api/v1/snomed&langRefset=900000000000509007')

  /* external browser is hidden by default, but when CT term is selected, it should be casted */
  $('div#embedded-externals').css('display', 'block')

  /* open corresponding tab */
  $('#ihtsdo-tabs a[href="#ihtsdo-' + tab + '-tab"]').tab('show')

  /* on manual search, go to details tab when clicking search results */
  $('tbody#ihtsdo-search-resultsTable').on('click', function (e) {
    var clickedElement = e.target
    if (clickedElement.hasAttribute('data-concept-id')) {
      $('#ihtsdo-tabs a[href="#ihtsdo-details-tab"]').tab('show')

      /* when something is selected allow saving */
      $('#tallenna').removeClass('disabled').removeClass('btn-secondary').addClass('btn-success')
    }
  })
}






/* check original table rows if contains certain value */
function checkTableRows (tableid, d) {
  if (d !== 0) {
    var User = []
    var UserT = []
    var Org = []
    var OrgT = []
    var Other = []
    var OtherT = []
    var Reject = []
    var RejectT = []
    var Bridged = []
    var BridgedT = []
    var i
    for (i = 0; i < d[0].length; i++) {
      User.push(d[0][i]['code_text'].toUpperCase())
      UserT.push(d[0][i]['term_text'].toUpperCase())
    }
    for (i = 0; i < d[1].length; i++) {
      Org.push(d[1][i]['code_text'].toUpperCase())
      OrgT.push(d[1][i]['term_text'].toUpperCase())
    }
    for (i = 0; i < d[2].length; i++) {
      Other.push(d[2][i]['code_text'].toUpperCase())
      OtherT.push(d[2][i]['term_text'].toUpperCase())
    }
    for (i = 0; i < d[3].length; i++) {
      Reject.push(d[3][i]['code_text'].toUpperCase())
      RejectT.push(d[3][i]['term_text'].toUpperCase())
    }
    for (i = 0; i < d[4].length; i++) {
      Bridged.push(d[4][i]['code_text'].toUpperCase())
      BridgedT.push(d[4][i]['term_text'].toUpperCase())
    }

    $(tableid + ' tbody tr').each(function () {
      var k = $(this).find('td.oldcode').text().toUpperCase()
      var t = $(this).find('td.oldterm').text().toUpperCase()

      if (Reject.indexOf(k) > -1 & RejectT.indexOf(t) > -1) {
        kIdx = Reject.indexOf(k)
        tIdx = RejectT.indexOf(t)
        if (Reject.indexOf(k) === RejectT.indexOf(t) | (Reject[kIdx] === Reject[tIdx] | RejectT[kIdx] === RejectT[tIdx])) {
          $(this).attr('class', 'table-danger')
          $(this).find('img.stop').css('filter', 'grayscale(10%)')
          $(this).find('td.status').html('Hylätty')
        }
      } else if (User.indexOf(k) > -1 & UserT.indexOf(t) > -1) {
        kIdx = User.indexOf(k)
        tIdx = UserT.indexOf(t)
        if (User.indexOf(k) === UserT.indexOf(t) | (User[kIdx] === User[tIdx] | UserT[kIdx] === UserT[tIdx])) {
          $(this).attr('class', 'table-success')
          $(this).find('td.status').html('Itse')
        }
      } else if (Org.indexOf(k) > -1 & OrgT.indexOf(t) > -1) {
        kIdx = Org.indexOf(k)
        tIdx = OrgT.indexOf(t)
        if (Org.indexOf(k) === OrgT.indexOf(t) | (Org[kIdx] === Org[tIdx] | OrgT[kIdx] === OrgT[tIdx])) {
          $(this).attr('class', 'table-primary')
          $(this).find('td.status').html('Oma org.')
        }
      } else if (Other.indexOf(k) > -1 & OtherT.indexOf(t) > -1) {
        kIdx = Other.indexOf(k)
        tIdx = OtherT.indexOf(t)
        if (Other.indexOf(k) === OtherT.indexOf(t) | (Other[kIdx] === Other[tIdx] | OtherT[kIdx] === OtherT[tIdx])) {
          $(this).attr('class', 'table-info')
          $(this).find('td.status').html('Muu org.')
        }
      } else if (Bridged.indexOf(k) > -1 & BridgedT.indexOf(t) > -1) {
        kIdx = Bridged.indexOf(k)
        tIdx = BridgedT.indexOf(t)
        if (Bridged.indexOf(k) === BridgedT.indexOf(t) | (Bridged[kIdx] === Bridged[tIdx] | BridgedT[kIdx] === BridgedT[tIdx])) {
          $(this).attr('class', 'table-secondary')
          $(this).find('td.status').html('Hyväksyttävä')
        }
      }
    })
  }
}






function modalResize (element) {
  var WHe = $(window).height() * 0.6
  var OHe = $(element).outerHeight()
  var HHe = $('.modal-header').outerHeight()
  var FHe = $('.modal-footer').outerHeight()
  var Extra = 50
  $('.modal-dialog').css('height', Math.min(Math.floor(WHe), OHe + HHe + FHe + Extra))
}






function OneSelected (Target) {
  if (Target.hasClass('selected')) {
    Target.removeClass('selected')
  } else {
    Target.parent().find('tr.selected').removeClass('selected')
    Target.addClass('selected')
  }
}






function FiddleButtons () {
  if ($.fn.DataTable.isDataTable('#bridge_concepts') & $.fn.DataTable.isDataTable('#similar_concepts')) {
    if ($('#bridge_concepts tbody tr').hasClass('selected') & $('#similar_concepts tbody tr').hasClass('selected')) {
      $('#btn-hyväksy').removeClass('disabled')
    } else {
      $('#btn-hyväksy').addClass('disabled')
    }
  } else if ($.fn.DataTable.isDataTable('#bridge_concepts') & !$.fn.DataTable.isDataTable('#similar_concepts')) {
    if ($('#bridge_concepts tbody tr').hasClass('selected')) {
      $('#btn-hyväksy').removeClass('disabled')
    } else {
      $('#btn-hyväksy').addClass('disabled')
    }
  }
}






function BoomTable (Target) {
  $(Target).DataTable().rows().remove().draw()
  $(Target).DataTable().destroy()
}






$(document).ready(function () {
  /* keyboard shortcuts: check caps-lock state (shortcuts only in use when capslock is on) */
  var caps
  document.addEventListener('keydown', function(event) {
    caps = event.getModifierState && event.getModifierState('CapsLock')
  })

  /* keyboard shortcuts: bind actions to certain keys pressed, can be one or multiple */
  $(document).on('keyup', function(e) {
    var table = $('#original').DataTable()
    if (caps === true & String.fromCharCode(e.which) === 'M') {
      table.page('next').draw('page')
    }
    if (caps === true & String.fromCharCode(e.which) === 'N') {
      table.page('previous').draw('page')
    }
  })






  /* mark rows that are already mapped (should override the auto-bridged rows) */
  $.get('_checker').done(function (d) {
    checkTableRows('#original', d)

    /* make tables nicer with jQuery DataTable */
    var OrderingColumn = 3
    var HiddenColumn = 7
    $('#original').DataTable({
      'order': [[ OrderingColumn, 'desc' ]],
      stateSave: false,
      'search': { 'regex': true },
      'pageLength': 25,
      'language': { 'url': "{{ url_for('static', filename='js/akheron/Finnish.json') }}" },
      select: {
        style: 'os',
        selector: 'td:first-child'
      },
      'columnDefs': [{
        'targets': [ HiddenColumn ],
        'visible': false,
        'searchable': false
      }]
    })

    /* neat loading animation */
    var table = $('#original').DataTable()
    table.on('draw', function () {
      $('div.loader').css({ opacity: 0, transition: 'opacity 0.5s' }).slideUp(1000)
      $('div.original-placeholder').slideDown(1000)
    })

    /* update progress bar */
    summarizeTable(table)
  })






  /* IHTSDO SNOMED-CT Browser API settings */
  var options = {
    serverUrl: 'http://browser.ihtsdotools.org/api/v1/snomed',
    edition: 'en-edition',
    release: 'v20180731',
    showIds: false,
    hideNotAcceptable: true,
    displayInactiveDescriptions: false,
    displaySynonyms: true,
    selectedView: 'inferred',
    displayChildren: false,
    langRefset: ['900000000000509007'],
    closeButton: false,
    collapseButton: false,
    linkerButton: true,
    subscribersMarker: true,
    searchMode: 'partialMatching',
    searchLang: 'english',
    diagrammingMarkupEnabled: false,
    statusSearchFilter: 'activeOnly',
    highlightByEffectiveTime: 'false'
  }






  /* activate button when something is typed */
  $('#hylkäys-syy').on('input', function () {
    $('#btn-reject').removeClass('disabled')
  })






  $('#btn-reject').on('click', function (e) {
    /* find out which concept row triggered modal window */
    var clickedRow = ''
    if (!$.fn.DataTable.isDataTable('#similar_concepts')) {
      clickedRow = $('#original').find('tr.selected')
    } else {
      clickedRow = $('#similar_concepts').find('tr.selected')
    }

    /* loading animation */
    clickedRow.find('div.img-loader').show()
    clickedRow.find('#stop-sign').css('display', 'none')

    /* do the mapping */
    var code = clickedRow.find('td.oldcode').text()
    var desc = clickedRow.find('td.oldterm').text()
    var comment = $('#hylkäys-syy').val() || ''

    $.post('_event', { 'old_code': code, 'old_term': desc, 'comment': comment }).done(function () {
      $('#btn-reject').html('Tallennetaan ...').addClass('btn-secondary').removeClass('btn-success')
      if (!$('#btn-reject').hasClass('disabled')) {
        $('#btn-reject').addClass('disabled')
      }
      if (!$('#btn-reject-reject').hasClass('disabled')) {
        $('#btn-reject-reject').addClass('disabled')
      }

      /* mark rows that are already mapped */
      $.get('_checker').done(function (d) {
        checkTableRows('#original', d)

        clickedRow.find('div.img-loader').hide()
        clickedRow.find('#stop-sign').css('display', 'block')
        clickedRow.removeClass('table-light')
        clickedRow.addClass('table-danger')
        clickedRow.find('img.stop').css('filter', 'grayscale(10%)')

        $('#rejectModal').fadeOut('slow')

        /* allow body scrolling after modal is closed */
        document.documentElement.style.overflow = 'scroll'
        document.body.scroll = 'yes'

        /* reset modal */
        $('#hylkäys-syy').val('')
        $('#btn-reject').removeClass('disabled').removeClass('btn-secondary').addClass('btn-success')
        $('#btn-reject').html('Hylkää konsepti')
        if ($('#btn-reject-reject').hasClass('disabled')) {
          $('#btn-reject-reject').removeClass('disabled')
        }

        /* update progress bar */
        summarizeTable($('#original').DataTable())
      })
    })
  })






  $('#btn-reject-reject').on('click', function (e) {
    e.preventDefault()

    $('#rejectModal').fadeOut('slow')

    /* allow body scrolling after modal is closed */
    document.documentElement.style.overflow = 'scroll'
    document.body.scroll = 'yes'

    $('#hylkäys-syy').val('')
    if (!$('#btn-reject').hasClass('disabled')) {
      $('#btn-reject').addClass('disabled')
    }

  })






  /* original term tab: unmapped terms on-click event */
  $('#original tbody').on('click', 'tr.table-light', function (e) {
    e.preventDefault()

    var $cell = $(e.target).closest('td > img')
    if ($cell.index() === 0) {
      /* allow only one row to be selected */
      OneSelected($(this))

      if ($(this).hasClass('table-light')) {
        $('#rejectModal').fadeIn('slow')
        modalResize('#rejectModal')

        /* prevent body from scrolling while modal is open and its content is scrolled */
        document.documentElement.style.overflow = 'hidden'
        document.body.scroll = 'no'
      }
    } else {
      /* flush Novel table */
      BoomTable('#novel')
      BoomTable('#novel_similar_concepts')

      /* allow only one row to be selected */
      OneSelected($(this))

      /* get original code and term */
      var code = $(this).find('td.oldcode').text()
      var desc = $(this).find('td.oldterm').text()
      var n = $(this).find('td.n').text()

      /* return possible novel terms from database */
      $.post('_fuzzymatch', { code, desc }).done(function (Matches) {
        /* populate table */
        for (var i = 0; i < Matches['matched'].length; i++) {
          var k = Matches['matched'][i]
          $('#novel tbody').append("<tr class='table-light'>" +
            "<td class='oldcode'>" + k[0] + '</td>' +
            '<td>' + k[1] + '</td>' +
            '<td>' + k[2] + '</td>' +
            '<td>' + k[3] + '</td>' +
            "<td class='newcode'>" + k[4] + '</td>' +
            '<td>' + k[5] + '</td>' +
            '<td>' + k[6] + '</td>' +
            '<td>' + k[7] + '</td>' +
            '</tr>')
        }

        /* invoke DataTable object */
        $('#novel').DataTable({
          'order': [[ 1, 'asc' ]],
          'pageLength': 10,
          'language': { 'url': "{{ url_for('static', filename='js/akheron/Finnish.json') }}" },
          'columnDefs': [{
            'targets': [ 3, 7 ],
            'visible': false,
            'searchable': false
          }]
        })

        /* show search panel if no results are returned */
        /* if (!$('#novel').DataTable().data().count()) {
          launchEmbeddedBrowser('138875005', options, 'search')
        } */
        /* show it anyway */
        launchEmbeddedBrowser('138875005', options, 'search')

        /* which similar terms are found from pathology data */
        $.post('_similars', { code, desc }).done(function (Matches) {
          if (Matches['similar'].length > 0) {
            for (var j = 0; j < Matches['similar'].length; j++) {
              var m = Matches['similar'][j]

              $('#novel_similar_concepts tbody').append("<tr class='table-light'>" +
                "<td class='hylkää'><img src='{{ url_for('static', filename='images/Stop_hand_caution.svg') }}' class='scaled-icon stop' alt='N/A' id='stop-sign'><div class='img-loader'><div class='center img-spinner' id='image-loading-animation'></div></div></td>" +
                "<td class='oldcode'>" + m['code_text'] + '</td>' +
                "<td class='oldterm'>" + m['term_text'] + '</td>' +
                "<td class='n'>" + m['obs_number'] + '</td>' +
                '</tr>')

              /* on last iteration, transform table to DataTable object */
              if (j === Matches['similar'].length - 1) {

                $('#novel_similar_concepts').DataTable({
                  'pageLength': 10,
                  'language': { 'url': "{{ url_for('static', filename='js/akheron/Finnish.json') }}" }
                })

                $.get('_checker').done(function (d) {
                  checkTableRows('#novel_similar_concepts', d)
                })

                /* if only one original term is retrieved, then mark it selected by default */
                if ($('#novel_similar_concepts').DataTable().rows().count() === 1) {
                  var Row = $('#novel_similar_concepts tbody tr')
                  if (!Row.hasClass('table-success') & !Row.hasClass('table-info') & !Row.hasClass('table-danger')) {
                    Row.addClass('selected')
                  }
                }

                /* activate/deactivate button */
                /* FiddleButtons() */
              }
            }
          }
          $('#novel-tab span.dynamic-original-term').empty().append(code)
          $('#novel-tab span.dynamic-original-term-desc').empty().append(desc)
          $('#novel-tab span.dynamic-original-term-n').empty().append(' (N=' + n + ')')

          $('div.novel-loader').css({ opacity: 0, transition: 'opacity 0.5s' }).slideUp(1000)
          $('div.novel-placeholder').slideDown(1000)
        }).fail(function () {
          /* TODO: proper failing */
          window.alert('something went wrong')
        })
      }).fail(function () {
        /* TODO: proper failing */
        window.alert('something went wrong')
      })

      /* redirect to Novel tab */
      $('#original-tabs a[href="#novel-tab"]').tab('show')
    }
  })






  $('#novel_similar_concepts tbody').on('click', 'tr', function (e) {
    e.preventDefault()

    var $cell = $(e.target).closest('td > img')
    if ($cell.index() === 0 & !$(this).hasClass('selected')) {
      /* allow only one row to be selected */
      OneSelected($(this))

      if ($(this).hasClass('table-light')) {
        $('#rejectModal').fadeIn('slow')
        modalResize('#rejectModal')

        /* prevent body from scrolling while modal is open and its content is scrolled */
        document.documentElement.style.overflow = 'hidden'
        document.body.scroll = 'no'

      } else if ($(this).hasClass('table-danger')) {
        $(this).find('div.img-loader').show()
        $(this).find('#stop-sign').css('display', 'none')

        var code = $(this).find('td.oldcode').text()
        var desc = $(this).find('td.oldterm').text()

        /* do the mapping */
        $.post('_event', { 'old_code': code, 'old_term': desc }).done(function () {
          /* mark rows that are already mapped */
          $.get('_checker').done(function (d) {
            checkTableRows('#original', d)

            /* update progress bar */
            summarizeTable($('#original').DataTable())

            $('#rejectModal').fadeOut('slow')

            /* allow body scrolling after modal is closed */
            document.documentElement.style.overflow = 'scroll'
            document.body.scroll = 'yes'
          })
        }).fail(function () {
          /* TODO: proper failing */
          window.alert('something went wrong')
        })
      }
    }

    if ($cell.index() !== 0 & $(this).hasClass('table-light')) {
      $(this).toggleClass('selected')

      /* activate/deactivate button */
      /* FiddleButtons() */
    }
  })






  /* Novel tab: fetched fuzzymatch terms on-click event */
  $('#novel tbody').on('click', 'tr.table-light', function (e) {
    e.preventDefault()

    /* allow only one row to be selected */
    OneSelected($(this))

    /* when something is selected allow saving and going to external IHTSDO browser */
    $('#tallenna').removeClass('disabled').removeClass('btn-secondary').addClass('btn-success')
    $('#ihtsdo_button').removeClass('disabled').removeClass('btn-secondary').addClass('btn-info')

    /* show embedded browser with additional details and optional search functionality */
    if ($(this).find('td.newcode').text()) {
      launchEmbeddedBrowser($(this).find('td.newcode').text(), options, 'details')
    } else {
      /* exception if no code can be found */
      launchEmbeddedBrowser('138875005', options, 'search')
    }
  })






  /* Novel tab: if nothing is returned (result table is empty) */
  $('#novel tbody').on('click', 'td.dataTables_empty', function (e) {
    e.preventDefault()

    /* show embedded browser with manual search functionality */
    launchEmbeddedBrowser('138875005', options, 'search')
  })






  /* Novel tab: table adjust */
  $(document).on('shown.bs.tab', 'a[data-toggle="tab"]', function (e) {
    $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust()
  })






  $('#tallenna').on('click', function (e) {
    e.preventDefault()

    /* change save button */
    $('#tallenna').addClass('disabled')

    /* find selected term */
    var oc = $('#novel-tab span.dynamic-original-term').text()
    var ot = $('#novel-tab span.dynamic-original-term-desc').text()
    var nc = $('#home-attributes-ihtsdo-details h5 #copy-content-custom').text().split('|')[0].trim()
    var nt = $('#home-attributes-ihtsdo-details h5 #copy-content-custom').text().split('|')[1].trim()

    $.post('_event', { 'old_code': oc, 'old_term': ot, 'new_code': nc, 'new_term': nt }).done(function () {
      $('#tallenna').html('Tallennetaan ...').addClass('btn-secondary').removeClass('btn-success')
      $('#peru').addClass('disabled')

      /* find out if similar concepts is present */
      if ($.fn.DataTable.isDataTable('#novel_similar_concepts') & $('#novel_similar_concepts tbody tr.selected').length > 0) {
        var SimCon = $('#novel_similar_concepts tbody tr.selected')

        /* find out which original concepts are to be mapped to the selected novel concept */
        SimCon.each(function (idx) {
          var s2 = $(this).find('td.oldcode').text()
          var s2d = $(this).find('td.oldterm').text()

          /* find out when is the last iteration of the loop */
          var isLastElement = idx === SimCon.length - 1

          /* do the mapping */
          $.post('_event', { 'old_code': s2, 'old_term': s2d, 'new_code': nc, 'new_term': nt }).done(function () {
            /* update main original concepts table on last iteration */
            if (isLastElement) {
              /* mark rows that are already mapped */
              $.get('_checker').done(function (d) {
                checkTableRows('#original', d)

                /* redirect to Original tab */
                $('#original-tabs a[href="#original-tab"]').tab('show')

                /* hide external browser */
                $('div#embedded-externals').css('display', 'none')

                /* flush Novel tables */
                BoomTable('#novel')
                BoomTable('#novel_similar_concepts')
                $('#novel-tab span.dynamic-original-term').empty()
                $('#novel-tab span.dynamic-original-term-desc').empty()
                $('#novel-tab span.dynamic-original-term-n').empty()

                /* bring back loading animation */
                $('div.novel-loader').css({ display: '', opacity: '', transition: '' })
                $('div.novel-placeholder').css('display', 'none')

                /* change save button */
                $('#tallenna').removeClass('disabled').removeClass('btn-secondary').addClass('btn-success')
                $('#tallenna').html('Hyväksy siltaus')
                $('#peru').removeClass('disabled')

                /* update progress bar */
                summarizeTable($('#original').DataTable())
              })
            }
          }).fail(function () {
            /* TODO: proper failing */
            window.alert('something went wrong')
          })
        })
      } else {
        /* mark rows that are already mapped */
        $.get('_checker').done(function (d) {
          checkTableRows('#original', d)

          /* redirect to Original tab */
          $('#original-tabs a[href="#original-tab"]').tab('show')

          /* hide external browser */
          $('div#embedded-externals').css('display', 'none')

          /* flush Novel table */
          BoomTable('#novel')
          BoomTable('#novel_similar_concepts')
          $('#novel-tab span.dynamic-original-term').empty()
          $('#novel-tab span.dynamic-original-term-desc').empty()
          $('#novel-tab span.dynamic-original-term-n').empty()

          /* bring back loading animation */
          $('div.novel-loader').css({ display: '', opacity: '', transition: '' })
          $('div.novel-placeholder').css('display', 'none')

          /* change save button */
          $('#tallenna').removeClass('disabled').removeClass('btn-secondary').addClass('btn-success')
          $('#tallenna').html('Hyväksy siltaus')
          $('#peru').removeClass('disabled')

          /* update progress bar */
          summarizeTable($('#original').DataTable())
        })
      }
    }).fail(function () {
      /* TODO: proper failing */
      window.alert('something went wrong')
    })
  })






  /* "Peru" button function */
  $('#peru').on('click', function() {
    /* redirect to Original tab */
    $('#original-tabs a[href="#original-tab"]').tab('show')

    /* hide external browser */
    $('div#embedded-externals').css('display', 'none')

    /* flush Novel table */
    BoomTable('#novel')
    BoomTable('#novel_similar_concepts')
    $('#novel-tab span.dynamic-original-term').empty()
    $('#novel-tab span.dynamic-original-term-desc').empty()
    $('#novel-tab span.dynamic-original-term-n').empty()

    /* bring back loading animation */
    $('div.novel-loader').css({ display: '', opacity: '', transition: '' })
    $('div.novel-placeholder').css('display', 'none')

    /* clear neo4j visualisation */
    /* if (viz) {
      viz.clearNetwork()
    } */
  })






  /* Original tab: bridged terms on-click event */
  $('#original tbody').on('click', 'tr.table-secondary', function (e) {
    e.preventDefault()

    var $cell = $(e.target).closest('td > img')
    if ($cell.index() === 0) {
      /* allow only one row to be selected */
      OneSelected($(this))

      if ($(this).hasClass('table-secondary')) {
        $('#rejectModal').fadeIn('slow')
        modalResize('#rejectModal')

        /* prevent body from scrolling while modal is open and its content is scrolled */
        document.documentElement.style.overflow = 'hidden'
        document.body.scroll = 'no'
      }
    } else {
      /* allow only one row to be selected */
      OneSelected($(this))

      /* flush tables */
      BoomTable('#bridge_concepts')
      BoomTable('#similar_concepts')

      /* allow manual search */
      $('#btn-manuaalinen').removeClass('disabled')

      /* find concept in focus */
      var code = $(this).find('td.oldcode').text()
      var desc = $(this).find('td.oldterm').text()
      var n = $(this).find('td.n').text()

      /* */
      $('#acceptModal span.dynamic-original-term').empty().append(code)
      $('#acceptModal span.dynamic-original-term-desc').empty().append(desc)
      $('#acceptModal span.dynamic-original-term-n').empty().append(' (N=' + n + ')')

      /* look for terms that are matched automatically */
      $.post('_autobridged', { code, desc }).done(function (Matches) {
        for (var i = 0; i < Matches['bridged'].length; i++) {
          var k = Matches['bridged'][i]

          $('#bridge_concepts tbody').append("<tr class='table-light'>" +
            "<td class='oldcode'>" + k['source_code_text'] + '</td>' +
            "<td class='oldterm'>" + k['source_term_text'] + '</td>' +
            "<td class='newcode'>" + k['destination_code_text'] + '</td>' +
            "<td class='newterm'>" + k['destination_term_text'] + '</td>' +
            '</tr>')

          /* on last iteration, transform table to DataTable object */
          if (i === Matches['bridged'].length - 1) {
            $('#bridge_concepts').DataTable({
              'pageLength': 10,
              'language': { 'url': "{{ url_for('static', filename='js/akheron/Finnish.json') }}" }
            })

            /* if only one novel concept is retrieved, then mark it selected by default */
            if ($('#bridge_concepts').DataTable().rows().count() === 1) {
              $('#bridge_concepts tbody tr').addClass('selected')
              /* $('#btn-hyväksy').removeClass("disabled") */
            }

            /* which similar terms are found from pathology data */
            for (var j = 0; j < Matches['similar'].length; j++) {
              var m = Matches['similar'][j]

              $('#similar_concepts tbody').append("<tr class='table-light'>" +
                "<td class='hylkää'><img src='{{ url_for('static', filename='images/Stop_hand_caution.svg') }}' class='scaled-icon stop' alt='N/A' id='stop-sign'><div class='img-loader'><div class='center img-spinner' id='image-loading-animation'></div></div></td>" +
                "<td class='oldcode'>" + m['code_text'] + '</td>' +
                "<td class='oldterm'>" + m['term_text'] + '</td>' +
                "<td class='n'>" + m['obs_number'] + '</td>' +
                "<td class='newcode'>" + m['destination_code_text'] + '</td>' +
                "<td class='newterm'>" + m['destination_term_text'] + '</td>' +
                '</tr>')

              /* on last iteration, transform table to DataTable object */
              if (j === Matches['similar'].length - 1) {

                $('#similar_concepts').DataTable({
                  'pageLength': 10,
                  'language': { 'url': "{{ url_for('static', filename='js/akheron/Finnish.json') }}" },
                  'initComplete': function (settings, json) {
                    modalResize('#acceptModal.modal-dialog.modal-content')
                  }
                })

                /* $.get('_checker').done(function (d) {
                  checkTableRows('#similar_concepts', d)
                }) */

                /* if only one original term is retrieved, then mark it selected by default */
                if ($('#similar_concepts').DataTable().rows().count() === 1) {
                  var Row = $('#similar_concepts tbody tr')
                  if (!Row.hasClass('table-success') & !Row.hasClass('table-info') & !Row.hasClass('table-danger')) {
                    Row.addClass('selected')
                  }
                }

                /* activate/deactivate button */
                FiddleButtons()
              }
            }
          }
        }
      }).fail(function () {
        /* TODO: proper failing */
        window.alert('something went wrong')
      })

      $('#acceptModal').fadeIn('slow')
      modalResize('#acceptModal')

      /* prevent body from scrolling while modal is open and its content is scrolled */
      document.documentElement.style.overflow = 'hidden'
      document.body.scroll = 'no'
    }
  })






  $('#similar_concepts tbody').on('click', 'tr', function (e) {
    e.preventDefault()

    var $cell = $(e.target).closest('td > img')
    if ($cell.index() === 0 & !$(this).hasClass('selected')) {
      /* allow only one row to be selected */
      OneSelected($(this))

      if ($(this).hasClass('table-light')) {
        $('#rejectModal').fadeIn('slow')
        modalResize('#rejectModal')

        /* prevent body from scrolling while modal is open and its content is scrolled */
        document.documentElement.style.overflow = 'hidden'
        document.body.scroll = 'no'
      } else if ($(this).hasClass('table-danger')) {
        $(this).find('div.img-loader').show()
        $(this).find('#stop-sign').css('display', 'none')

        var code = $(this).find('td.oldcode').text()
        var desc = $(this).find('td.oldterm').text()

        /* do the mapping */
        $.post('_event', { 'old_code': code, 'old_term': desc }).done(function () {
          /* mark rows that are already mapped */
          $.get('_checker').done(function (d) {
            checkTableRows('#original', d)

            /* update progress bar */
            summarizeTable($('#original').DataTable())

            $('#rejectModal').fadeOut('slow')

            /* allow body scrolling after modal is closed */
            document.documentElement.style.overflow = 'scroll'
            document.body.scroll = 'yes'
          })
        }).fail(function () {
          /* TODO: proper failing */
          window.alert('something went wrong')
        })
      }
    }

    if ($cell.index() !== 0 & $(this).hasClass('table-light')) {
      $(this).toggleClass('selected')

      /* activate/deactivate button */
      FiddleButtons()
    }
  })






  /* "Manuaalinen haku" button function */
  $('#btn-manuaalinen').on('click', function() {
    var searchTable = $('#original tbody tr.selected')
    var code = searchTable.find('td.oldcode').text()
    var desc = searchTable.find('td.oldterm').text()
    var n = searchTable.find('td.n').text()

    /* transfer selected original term to Novel tab */
    $('#novel-tab span.dynamic-original-term').empty().append(code)
    $('#novel-tab span.dynamic-original-term-desc').empty().append(desc)
    $('#novel-tab span.dynamic-original-term-n').empty().append(' (N=' + n + ')')

    /* when something is selected allow saving and going to external IHTSDO browser */
    $('#tallenna').removeClass('disabled').removeClass('btn-secondary').addClass('btn-success')
    $('#ihtsdo_button').removeClass('disabled').removeClass('btn-secondary').addClass('btn-info')

    /* show embedded browser with additional details and optional search functionality */
    launchEmbeddedBrowser('138875005', options, 'search')

    /* redirect to Novel tab */
    $('#original-tabs a[href="#novel-tab"]').tab('show')

    $('div.novel-loader').css({ opacity: 0, transition: 'opacity 0.5s' }).slideUp(1000)
    $('div.novel-placeholder').slideDown(1000)

    /* hide modal */
    $('#acceptModal').fadeOut('slow')

    /* allow body scrolling after modal is closed */
    document.documentElement.style.overflow = 'scroll'
    document.body.scroll = 'yes'
  })






  /* bind clicking events to modal tables */
  $('#bridge_concepts tbody').on('click', 'tr', function (e) {
    e.preventDefault()

    /* allow only one row to be selected */
    OneSelected($(this))

    /* activate/deactivate button */
    FiddleButtons()
  })






  /* Original tab: rejected terms on-click event */
  $('#original tbody').on('click', 'tr.table-danger', function (e) {
    e.preventDefault()

    /* allow only one row to be selected */
    OneSelected($(this))

    var code = $(this).find('td.oldcode').text()
    var desc = $(this).find('td.oldterm').text()

    var $cell = $(e.target).closest('td > img')
    if ($cell.index() === 0) {
      $(this).find('div.img-loader').show()
      $(this).find('#stop-sign').css('display', 'none')

      var activeRow = $(this)
      /* do the mapping */
      $.post('_event', { 'old_code': code, 'old_term': desc }).done(function () {
        /* mark rows that are already mapped */
        $.get('_checker').done(function (d) {
          checkTableRows('#original', d)
          activeRow.find('div.img-loader').hide()
          activeRow.find('#stop-sign').css('display', 'block')
          activeRow.removeClass('table-danger').addClass('table-light')
          /* activeRow.addClass('table-light') */
          activeRow.find('img.stop').css('filter', 'grayscale(90%)')

          /* update progress bar */
          summarizeTable($('#original').DataTable())
        })
      }).fail(function () {
        /* TODO: proper failing */
        window.alert('something went wrong')
      })
    } else {
      $('#btn-change-mapping').addClass('disabled')
      $('#mapped-concept-source-system').empty()
      $('#mapped-concept-source').empty()
      $('#mapped-concept-target-system').empty()
      $('#mapped-concept-target').empty()

      $('#mapper-detailed-info').empty()

      $.post('_mapped_info', { code, desc }).done(function (s) {
        var s = ss['mapd']
        var SrcTitle = '<h4>Lähdekoodiston ' + s[0][5] + ' (' + s[0][6] + ') konsepti:</h4>'
        var SrcConc
        var TrgTitle
        var TrgConc

        if (s[0][9] === null) {
          SrcConc = "<button type='button' class='btn btn-danger btn-lg'><h4>" + s[0][8] + '  (' + s[0][7] + ')</h4></button>'
          TrgTitle = '<h4>Hylätty konsepti. Ei kohdekoodistoa.</h4>'
        } else {
          SrcConc = "<button type='button' class='btn btn-success btn-lg'><h4>" + s[0][8] + '  (' + s[0][7] + ')</h4></button>'
          TrgTitle = '<h4>Kohdekoodiston ' + s[0][9] + ' (' + s[0][10] + ') konsepti:</h4>'
          TrgConc = "<button type='button' class='btn btn-success btn-lg'><h4>" + s[0][12] + '  (' + s[0][11] + ')</h4></button>'
        }

        var Siltaaja = '<h5>Käyttäjä: ' + s[0][2] + ', ' + s[0][3] + ' (' + s[0][4] + ')<br>' + s[0][14] + '</h5>'
        if (s[0][13]) {
          var Kommentti = '<h5>Kommentti: ' + s[0][13] + '</h5>'
        }

        /* Populate buttons to users home page */
        $(function () {
          var SrcTitleElem = document.getElementById('mapped-concept-source-system')
          var SrcConcept = document.getElementById('mapped-concept-source')
          SrcTitleElem.innerHTML += SrcTitle
          SrcConcept.innerHTML += SrcConc

          var TrgTitleElem = document.getElementById('mapped-concept-target-system')
          var TrgConcept = document.getElementById('mapped-concept-target')
          TrgTitleElem.innerHTML += TrgTitle
          if (TrgConc) {
            TrgConcept.innerHTML += TrgConc
          }

          var MapperInfo = document.getElementById('mapper-detailed-info')
          MapperInfo.innerHTML += Siltaaja
          if (Kommentti) {
            MapperInfo.innerHTML += Kommentti
          }
        })
      })

      /* Define modal size dynamically */
      modalResize('#mappedModal')

      /* spawn modal */
      $('#mappedModal').fadeIn('slow')

      /* prevent body from scrolling while modal is open and its content is scrolled */
      document.documentElement.style.overflow = 'hidden'
      document.body.scroll = 'no'

      /* add function to closing button */
      $('#mappedModal button#btn-close').on('click', function () {
        $('#mappedModal').fadeOut('slow')
        $('#btn-change-mapping').removeClass('disabled')

        /* allow body scrolling after modal is closed */
        document.documentElement.style.overflow = 'scroll'
        document.body.scroll = 'yes'
      })
    }
  })






  /* Original tab: other organisation mapped terms on-click event */
  $('#original tbody').on('click', 'tr.table-info', function (e) {
    e.preventDefault()

    var $cell = $(e.target).closest('td > img')
    if ($cell.index() === 0 & !$(this).hasClass('selected')) {
      if ($(this).hasClass('table-info')) {
        $('#rejectModal').fadeIn("slow")
        modalResize('#rejectModal')

        /* prevent body from scrolling while modal is open and its content is scrolled */
        document.documentElement.style.overflow = 'hidden'
        document.body.scroll = 'no'
      } else if ($(this).hasClass('table-danger')) {
        $(this).find('div.img-loader').show()
        $(this).find('#stop-sign').css('display', 'none')

        var code = $(this).find('td.oldcode').text()
        var desc = $(this).find('td.oldterm').text()

        /* do the mapping */
        $.post('_event', { 'old_code': code, 'old_term': desc }).done(function () {
          /* mark rows that are already mapped */
          $.get('_checker').done(function (d) {
            checkTableRows('#original', d)

            /* update progress bar */
            summarizeTable($('#original').DataTable())
          })
        }).fail(function () {
          /* TODO: proper failing */
          window.alert('something went wrong')
        })
      } else {
        /* TODO */
      }
    } else {
      /* allow only one row to be selected */
      OneSelected($(this))

      /* flush tables */
      BoomTable('#bridge_concepts')

      /* make similar table empty */
      BoomTable('#similar_concepts')

      $('#similars-block').css("display", "none")

      /* allow manual search and accepting mapping from other organisation */
      $('#btn-manuaalinen').removeClass('disabled')

      /* find concept in focus */
      var code = $(this).find('td.oldcode').text()
      var desc = $(this).find('td.oldterm').text()
      var newc = $(this).find('td.newcode').text()
      var newt = $(this).find('td.newterm').text()

      /* look for terms that are already mapped */
      $.post('_other_mapped', { code, desc }).done(function (Matches) {
        for (var i = 0; i < Matches['mapped'].length; i++) {
          var k = Matches['mapped'][i]

          $('#bridge_concepts tbody').append("<tr class='table-light'>" +
            "<td class='oldcode'>" + k['source_code_text'] + '</td>' +
            "<td class='oldterm'>" + k['source_term_text'] + '</td>' +
            "<td class='newcode'>" + k['destination_code_text'] + '</td>' +
            "<td class='newterm'>" + k['destination_term_text'] + '</td>' +
            '</tr>')

          /* on last iteration, transform table to DataTable object */
          if (i === Matches['mapped'].length - 1) {
            $('#bridge_concepts').DataTable({
              'pageLength': 10,
              'language': { 'url': "{{ url_for('static', filename='js/akheron/Finnish.json') }}" }
            })

            /* if only one novel concept is retrieved, then mark it selected by default */
            if ($('#bridge_concepts').DataTable().rows().count() === 1) {
              $('#bridge_concepts tbody tr').addClass('selected')
              /* $('#btn-hyväksy').removeClass("disabled") */
            }

            /* activate/deactivate button */
            FiddleButtons()
          }
        }
      }).fail(function () {
        /* TODO: proper failing */
        window.alert('something went wrong')
      })

      $('#acceptModal').fadeIn('slow')
      modalResize('#acceptModal')

      /* prevent body from scrolling while modal is open and its content is scrolled */
      document.documentElement.style.overflow = 'hidden'
      document.body.scroll = 'no'
    }
  })






  /* Original tab: mapped terms on-click event (user self, or from users organisation) */
  $('#original tbody').on('click', 'tr.table-primary, tr.table-success', function (e) {
    e.preventDefault()

    /* allow only one row to be selected */
    OneSelected($(this))

    var code = $(this).find('td.oldcode').text()
    var desc = $(this).find('td.oldterm').text()

    $('#mapped-concept-source-system').empty()
    $('#mapped-concept-source').empty()
    $('#mapped-concept-target-system').empty()
    $('#mapped-concept-target').empty()

    $('#mapper-detailed-info').empty()
    $('#mapped-concept-history').empty()

    $.post('_mapped_info', { code, desc }).done(function (ss) {
      var s = ss['mapd']
      var SrcTitle = '<h4>Lähdekoodiston ' + s[0][5] + ' (' + s[0][6] + ') konsepti:</h4>'
      var TrgTitle = '<h4>Kohdekoodiston ' + s[0][9] + ' (' + s[0][10] + ') konsepti:</h4>'

      var SrcConc = "<button type='button' class='btn btn-success btn-lg'><h4>" + s[0][8] + '  (' + s[0][7] + ')</h4></button>'
      var TrgConc = "<button type='button' class='btn btn-success btn-lg'><h4>" + s[0][12] + '  (' + s[0][11] + ')</h4></button>'

      var Siltaaja = '<h5>Käyttäjä: ' + s[0][2] + ', ' + s[0][3] + ' (' + s[0][4] + ')<br>' + s[0][14] + '</h5>'
      if (s[0][13]) {
        var Kommentti = '<h5>Kommentti: ' + s[0][13] + '</h5>'
      }

      /* Populate buttons to users home page */
      $(function () {
        var SrcTitleElem = document.getElementById('mapped-concept-source-system')
        var SrcConcept = document.getElementById('mapped-concept-source')
        SrcTitleElem.innerHTML += SrcTitle
        SrcConcept.innerHTML += SrcConc

        var TrgTitleElem = document.getElementById('mapped-concept-target-system')
        var TrgConcept = document.getElementById('mapped-concept-target')
        TrgTitleElem.innerHTML += TrgTitle
        TrgConcept.innerHTML += TrgConc

        var MapperInfo = document.getElementById('mapper-detailed-info')
        MapperInfo.innerHTML += Siltaaja
        if (Kommentti) {
          MapperInfo.innerHTML += Kommentti
        }

        var ConceptHistory = document.getElementById('mapped-concept-history')
        if (ss['hist'].length > 0) {
          var h = ss['hist']
          for (var i = 0; i < h.length; i++) {
            if (h[i][14] === "User mapping") {
              ConceptHistory.innerHTML += '<h5>' + h[i][15] + ': ' + h[i][2] + ', ' + h[i][3] + ' (' + h[i][4] + ') - ' + h[i][7] + ' ' + h[i][8] + ' >>>> ' + h[i][11] + ' ' + h[i][12]
            } else if (h[i][14] === "Incorrect concept") {
              ConceptHistory.innerHTML += '<h5>' + h[i][15] + ': ' + h[i][2] + ', ' + h[i][3] + ' (' + h[i][4] + ') - ' + h[i][7] + ' ' + h[i][8] + ' is ' + h[i][14] + ': ' + h[i][13]
            }
          }
        }
      })
    })

    /* Define modal size dynamically */
    modalResize('#mappedModal')

    /* spawn modal */
    $('#mappedModal').fadeIn('slow')

    /* prevent body from scrolling while modal is open and its content is scrolled */
    document.documentElement.style.overflow = 'hidden'
    document.body.scroll = 'no'

    /* add function to closing button */
    $('#mappedModal button#btn-close').on('click', function () {
      $('#mappedModal').fadeOut('slow')

      /* allow body scrolling after modal is closed */
      document.documentElement.style.overflow = 'scroll'
      document.body.scroll = 'yes'
    })
  })






  $('#btn-change-mapping').on('click', function (e) {
    e.preventDefault()

    /* flush Novel table */
    BoomTable('#novel')

    /* get original code and term */
    var code = $('#original tbody tr.selected').find('td.oldcode').text()
    var desc = $('#original tbody tr.selected').find('td.oldterm').text()
    var n = $('#original tbody tr.selected').find('td.n').text()

    /* return possible novel terms from database */
    $.post('_fuzzymatch', { code, desc }).done(function (Matches) {
      /* populate table */
      for (var i = 0; i < Matches['matched'].length; i++) {
        var k = Matches['matched'][i]
        $('#novel tbody').append("<tr class='table-light'>" +
          "<td class='oldcode'>" + k[0] + '</td>' +
          '<td>' + k[1] + '</td>' +
          '<td>' + k[2] + '</td>' +
          '<td>' + k[3] + '</td>' +
          "<td class='newcode'>" + k[4] + '</td>' +
          '<td>' + k[5] + '</td>' +
          '<td>' + k[6] + '</td>' +
          '<td>' + k[7] + '</td>' +
          '</tr>')
      }

      /* invoke DataTable object */
      $('#novel').DataTable({
        'order': [[ 1, 'asc' ]],
        'pageLength': 10,
        'language': { 'url': "{{ url_for('static', filename='js/akheron/Finnish.json') }}" },
        'columnDefs': [{
          'targets': [ 3, 7 ],
          'visible': false,
          'searchable': false
        }]
      })

      $('#novel-tab span.dynamic-original-term').empty().append(code)
      $('#novel-tab span.dynamic-original-term-desc').empty().append(desc)
      $('#novel-tab span.dynamic-original-term-n').empty().append(' (N=' + n + ')')

      $('div.novel-loader').css({ opacity: 0, transition: 'opacity 0.5s' }).slideUp(1000)
      $('div.novel-placeholder').slideDown(1000)

      /* hide modal */
      $('#mappedModal').fadeOut('slow')

      /* allow body scrolling after modal is closed */
      document.documentElement.style.overflow = 'scroll'
      document.body.scroll = 'yes'

      /* redirect to Novel tab */
      $('#original-tabs a[href="#novel-tab"]').tab('show')
    }).fail(function () {
      /* TODO: proper failing */
      window.alert('something went wrong')
    })
  })






  /* bind events to modal buttons */
  $('#btn-hyväksy').on('click', function () {
    var BrCon = $('#bridge_concepts tbody tr.selected')

    /* find out which novel concept was selected */
    var ct = BrCon.find('td.newcode').text()
    var ctn = BrCon.find('td.newterm').text()

    /* find out if similar concepts is present */
    if ($.fn.DataTable.isDataTable('#similar_concepts')) {
      var SimCon = $('#similar_concepts tbody tr.selected')

      /* find out which original concepts are to be mapped to the selected novel concept */
      SimCon.each(function (idx) {
        var s2 = $(this).find('td.oldcode').text()
        var s2d = $(this).find('td.oldterm').text()

        /* find out when is the last iteration of the loop */
        var isLastElement = idx === SimCon.length - 1

        /* do the mapping */
        $.post('_event', { 'old_code': s2, 'old_term': s2d, 'new_code': ct, 'new_term': ctn }).done(function () {
          $('#btn-hyväksy').html('Tallennetaan ...').addClass('btn-secondary').removeClass('btn-success')
          if (!$('#btn-hyväksy').hasClass('disabled')) {
            $('#btn-hyväksy').addClass('disabled')
          }
          if (!$('#btn-manuaalinen').hasClass('disabled')) {
            $('#btn-manuaalinen').addClass('disabled')
          }
          if (!$('#btn-sulje').hasClass('disabled')) {
            $('#btn-sulje').addClass('disabled')
          }

          /* update main original concepts table on last iteration */
          if (isLastElement) {
            /* mark rows that are already mapped */
            $.get('_checker').done(function (d) {
              checkTableRows('#original', d)

              /* update progress bar */
              summarizeTable($('#original').DataTable())

              $('#acceptModal').fadeOut('slow')

              /* allow body scrolling after modal is closed */
              document.documentElement.style.overflow = 'scroll'
              document.body.scroll = 'yes'

              /* change save button */
              $('#btn-hyväksy').removeClass('disabled').removeClass('btn-secondary').addClass('btn-success')
              $('#btn-hyväksy').html('Hyväksy siltaus')
              $('#btn-sulje').removeClass('disabled')
            })
          }
        }).fail(function () {
          /* TODO: proper failing */
          window.alert('something went wrong')
        })
      })
    } else {
      /* find out original concept was selected */
      var cto = BrCon.find('td.oldcode').text()
      var ctno = BrCon.find('td.oldterm').text()

      /* do the mapping */
      $.post('_event', { 'old_code': cto, 'old_term': ctno, 'new_code': ct, 'new_term': ctn }).done(function () {
        $('#btn-hyväksy').html('Tallennetaan ...').addClass('btn-secondary').removeClass('btn-success')
        if (!$('#btn-hyväksy').hasClass('disabled')) {
          $('#btn-hyväksy').addClass('disabled')
        }
        if (!$('#btn-manuaalinen').hasClass('disabled')) {
          $('#btn-manuaalinen').addClass('disabled')
        }
        if (!$('#btn-sulje').hasClass('disabled')) {
          $('#btn-sulje').addClass('disabled')
        }

        /* mark rows that are already mapped */
        $.get('_checker').done(function (d) {
          checkTableRows('#original', d)

          /* update progress bar */
          summarizeTable($('#original').DataTable())

          $('#acceptModal').fadeOut('slow')

          /* allow body scrolling after modal is closed */
          document.documentElement.style.overflow = 'scroll'
          document.body.scroll = 'yes'

          /* change save button */
          $('#btn-hyväksy').removeClass('disabled').removeClass('btn-secondary').addClass('btn-success')
          $('#btn-hyväksy').html('Hyväksy siltaus')
          $('#btn-sulje').removeClass('disabled')
          $('#similars-block').css("display", "block")
        })
      }).fail(function () {
        /* TODO: proper failing */
        window.alert('something went wrong')
      })
    }
  })






  /* "Sulje" button */
  $('#acceptModal button#btn-sulje').on('click', function () {
    /* flush tables */
    BoomTable('#bridge_concepts')
    BoomTable('#similar_concepts')
    $('#acceptModal').fadeOut('slow')

    /* allow body scrolling after modal is closed */
    document.documentElement.style.overflow = 'scroll'
    document.body.scroll = 'yes'

    /* make buttons unclickable */
    $('#btn-hyväksy').addClass('disabled')
    $('#btn-manuaalinen').addClass('disabled')
  })






  /* filtering buttons */
  $('#filtering-buttons > li > button').click(function () {
    /* disable button for a moment to prevent double-clicking */
    var Btns = $('#filtering-buttons > li > button')
    for (var i = 0; i < Btns.length; i++) {
      $(Btns[i]).prop('disabled', true)
      setTimeout(function (btn) { btn.prop('disabled', false) }, 800, $(Btns[i]))
    }

    /* catch DOM */
    var tabl = $('#original').DataTable()
    var ClickedId = $(this).attr('id')
    var hiddenRow = {}

    /* if filter is active, deactivate filtering */
    if ($(this).hasClass('active')) {
      $(this).removeClass('active')
      $.fn.dataTable.ext.search.pop()

      /* find out current position on table before redrawing */
      if (!tabl.rows({ page: 'current' })[0][0]) {
        var toprow = hiddenRow.hideRows
      }
      else if (!toprow) {
        var toprow = tabl.rows({ page: 'current' })[0][0]
      }

      /* apply un-filtering and update table */
      tabl.draw()

      /* check if top row is still on visible page of redrawn filtered table, otherwise navigate to that page */
      if (tabl.rows({ page: 'current' })[0].indexOf(toprow) === -1) {
        tabl.page(tabl.rows()[0].indexOf(toprow) / tabl.page.info().length).draw('page')
      }
    } else {
      /* if filter is not active, activate filtering */
      $(this).parent().parent().find('button.active').removeClass('active')
      $(this).addClass('active')

      /* which rows are currently visible */
      var visibleRows = $(tabl.rows({ page: 'current' }).nodes())
      var rowIndices = tabl.rows({ page: 'current' })[0]

      /* loop through rows and find first filter-matching value */
      for (i = 0; i < visibleRows.length; i++) {
        if ($(visibleRows[i]).hasClass(ClickedId.replace('filter-',''))) {
          /* take index of filter-matching row */
          var toprow = rowIndices[i]
          hiddenRow.hideRows = rowIndices[i]

          /* stop looping */
          break
        }
      }

      /* actual filtering and table re-draw */
      $.fn.dataTable.ext.search.pop()
      $.fn.dataTable.ext.search.push(
        function(settings, data, dataIndex) {
          if (settings.nTable.id === 'original') {
            return $(tabl.row(dataIndex).node()).hasClass(ClickedId.replace('filter-','')) ? true : false;
          }
          else {
            return true
          }
        }
      )
      tabl.draw()

      /* check if table is empty or not and update top row indice */
      if (!tabl.rows({ page: 'current' })[0][0]) {
        var toprow = hiddenRow.hideRows
      } else if (!toprow) {
        /* if table has rows, but visible page before filtering did not contain any filter-matching rows, then take index of first row on whole table */
        var toprow = tabl.rows({ page: 'current' })[0][0]
      }

      /* check if filter-matching row is still on visible page, otherwise navigate to that page */
      if (tabl.rows({ page: 'current' })[0].indexOf(toprow) === -1) {
        tabl.page(tabl.rows({ search: 'applied' })[0].indexOf(toprow) / tabl.page.info().length).draw('page')
      }
    }

    /* remove focus from button due mouse click */
    $(this).blur()
  })
})






/* NEO4J visualisation */
/*
var viz;
function draw(id) {
*/
/* neo4j server configuration */
/*
  var config = {
    container_id: "graphdb-viz",
    server_url: "bolt://sonja.vsshp.net:7687",
*/
/* TODO: figure out how to obfuscate server credentials */
/*
    server_user: "neo4j",
    server_password: "password",
    labels: {
      "ObjectConcept": {
        "caption": "FSN",
        "size": "active",
        "community": "nodetype"
      }
    },
    relationships: {
      "ISA": {
        "thickness": "weight",
        "caption": false
      }
    },
*/
    /* TODO: decide what kind of relations are useful to display in a graph */
/*    initial_cypher: "MATCH (n:ObjectConcept {sctid:'" + id + "'})-[r:ISA]->(m)-[q:ISA]->(k) RETURN * LIMIT 100" */
    /*initial_cypher: "MATCH (n:ObjectConcept { sctid: " + id + "})-[r:ISA]->(m) RETURN * LIMIT 100"*/
    /*initial_cypher: "MATCH (n)-[r:ISA]->(m)-[q:ISA]->(k) RETURN * LIMIT 100"*/
/*  }; */

  /* update visualisation */
/*  viz = new NeoVis.default(config);
  viz.render()
}*/






/* visualisation clicking event */
/*
$("#graphdb-viz").on('click', function () {
  elem = $(this)
  console.log(elem)
*/
  /* TODO: figure out how to make graph clickable and clicking a node takes back to updated SNOMED-CT subpage */
  /*function getTooltip() {
    console.log(elem.find("div.vis-tooltip").html().match(/sctid.+\>+(.*)*?\<br\>/g))
  }
  setTimeout(getTooltip, 1000)*/

  //$(this).addClass("active").siblings().removeClass("active")
/*})*/

</script>

{% endblock %}
