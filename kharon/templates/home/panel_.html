<!-- {% import "bootstrap/utils.html" as utils %} -->

{% extends "base.html" %}

{% block title %}Etusivu{% endblock %}

{% block sisältö %}
<div class="content-section">
  <div class="contents">
    {% if current_user.is_authenticated %}

      <!-- navigation tabs -->
      <nav class="navbar navbar-expand-lg navbar-light">
        <div class="collapse navbar-collapse">

          <!-- Original terms tabs -->
          <ul class="nav nav-tabs mr-auto" role="tablist" id="original-tabs">
            <li class="nav-item active"><a href="#original-tab" class="nav-link active show" data-toggle="tab" aria-expand="true">Lähdekoodisto{% if source %}: {{ source }}{% endif %}</a></li>
            <li class="nav-item"><a href="#accept-tab" class="nav-link" data-toggle="tab" aria-expand="true">Ehdotuksen hyväksyntä</a></li>
            <li class="nav-item"><a href="#reject-tab" class="nav-link" data-toggle="tab" aria-expand="true">Konseptin hylkäys</a></li>
            <li class="nav-item"><a href="#novel-tab" class="nav-link" data-toggle="tab" aria-expand="true">Kohdekoodisto{% if target %}: {{ target }}{% endif %}</a></li>
            <li class="nav-item"><a href="#mapped-tab" class="nav-link" data-toggle="tab" aria-expand="true">Siltauksen tarkastelu</a></li>
            <li class="nav-item"><a href="#note-tab" class="nav-link" data-toggle="tab" aria-expand="true">Muistiinpanot</a></li>
          </ul>
        </div>
      </nav>



      <div class="tab-content">

        <!-- Original term tab -->
        <div class="tab-pane active" id="original-tab">

          <!-- Loading animation -->
          <div class="loader">
            <div class="center spinner" id="loading-animation"></div>
          </div>

          <!-- table container -->
          <div class="original-placeholder">
            <div class="help-text">
              <p>Alla olevassa taulukossa näet organisaatiossasi käytössä olevat ja olleet 'koodi + termi' parit (konseptit). Konseptille näytetään niiden volyymi organisaatiossasi (N) ja aikajakso jolloin kyseinen konsepti on ollut käytössä, mikäli tiedot ovat olleet saatavissa.</p>
            </div>

            <!-- Filtering buttons -->
            <nav class="navbar navbar-expand-lg navbar-light">
              <div class="collapse navbar-collapse justify-content-end">
                <ul class="navbar-nav" id="filtering-buttons">
                  <li class="nav-item"><button type="button" class="btn btn-sm btn-light" id="filter-table-light">Siltaamattomat</button></li>
                  <li class="nav-item"><button type="button" class="btn btn-sm btn-secondary" id="filter-table-secondary">Ehdotukset</button></li>
                  <li class="nav-item"><button type="button" class="btn btn-sm btn-success" id="filter-table-success">Valmiit</button></li>
                </ul>
              </div>
            </nav>

            <table id="original" class="table table-hover table-sm">
              <thead class="thead-light">
                <tr>
                  <th>Hyl</th><th>Huom</th><th>Lähdekoodi</th><th>Lähdetermi</th><th>Kohdekoodi</th><th>Kohdetermi</th><th>N</th><th>Alkaen</th><th>Asti</th><th>Sillannut</th><th>Aikaleima</th><th>Konsepti</th>
                </tr>
              </thead>
              <tbody>
                {% for original in originals %}
                  <tr class="table-light">
                    <td class="hylkää"><img src="{{ url_for('static', filename='images/Stop_hand_caution.svg') }}" class='scaled-icon stop' alt='N/A' id='stop-sign'><div class="img-loader"><div class="center img-spinner" id="image-loading-animation"></div></div></td>
                    <td class="huomio"><span rel='tooltip' data-placement='left'><img src="{{ url_for('static', filename='images/Pen_-_The_Noun_Project.svg') }}" class='scaled-icon huom' alt='Huom' id='huom-sign'></span><div class="img-loader"><div class="center img-spinner" id="image-loading-animation"></div></div></td>
                    <td class="oldcode">{{ original.code_text }}</td>
                    <td class="oldterm">{{ original.term_text }}</td>
                    <td class="newcode">{% if original.destination_code_text %}{{ original.destination_code_text }}{% endif %}</td>
                    <td class="newterm">{% if original.destination_term_text %}{{ original.destination_term_text }}{% endif %}</td>
                    <td class="n">{{ original.obs_number }}</td>
                    <td class="alkaen">{{ original.first_obs_date }}</td>
                    <td class="asti">{{ original.last_obs_date }}</td>
                    <td class="status">{% if original.last_name %}{{ original.last_name }}, {{ original.first_name }} ({{ original.organisation_name }}){% endif %}</td>
                    <td class="maptime">{% if original.insert_ts %}{{ original.insert_ts }}{% endif %}</td>
                    <td class="concept-id">{{ original.concept_id }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="progress" id="progress-concepts">
            <div class="progress-bar bg-secondary" id="progress-bridged" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
            <!-- <div class="progress-bar bg-danger" id="progress-rejected" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div> -->
            <div class="progress-bar bg-success" id="progress-user" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
            <div id="progress-text"><p>Sillattu <span id="progress-mapped"></span> / <span id="progress-total"></span> konseptia</p></div>
          </div>
          <div class="progress" id="progress-samples">
            <div class="progress-bar progress-bar-striped bg-secondary" id="progress-bridged-sample" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
            <!-- <div class="progress-bar progress-bar-striped bg-danger" id="progress-rejected-sample" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div> -->
            <div class="progress-bar progress-bar-striped bg-success" id="progress-user-sample" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
            <div id="progress-text-sample"><p>Sillattu <span id="progress-mapped-sample"></span> / <span id="progress-total-sample"></span> näytettä</p></div>
          </div>
        </div>



        <!-- Accept mapping tab -->
        <div class="tab-pane" id="accept-tab">
          <div class="help-text">
            <p>Virallisesta siltaustiedostosta löytyy yksi tai useita vastineita alkuperäiselle konseptille, jota olet siltaamassa. Valitse näistä sopivin kohdekonsepti ("Kohdekoodi" ja "Kohdetermi" -pari). Voit lisäksi valita alemmasta taulukosta muita alkuperäisen (organisaatiosi) koodiston konsepteja ja sillata ne samaan valitsemaasi kohdekonseptiin.</p>
          </div>
          <div id="bridge-title"><h5>Virallisesta koodiston siltauksesta ja muiden organisaatioiden siltauksista löytyvät vastineet:</h5></div>
          <table id='bridge_concepts' class='table table-hover table-sm'>
            <thead class='thead-light'>
              <tr><th>Lähdekoodi</th><th>Lähdetermi</th><th>Virallinen kohdekoodi</th><th>Virallinen kohdetermi</th></tr>
            </thead>
            <tbody> <!-- populated with jQuery --> </tbody>
          </table><br>
          <div id="similars-block">
            <h5>Samankaltaisia koodeja ja termejä alkuperäisessä (organisaatiosi) koodistossa:</h5>
            <table id='similar_concepts' class='table table-hover table-sm'>
              <thead class='thead-light'>
                <tr><th>Hyl</th><th>Huom</th><th>Organisaatiosi koodi</th><th>Organisaatiosi termi</th><th>N</th><th>Sillattavan koodiston kohdekoodi</th><th>Sillattavan koodiston kohdetermi</th></tr>
              </thead>
              <tbody> <!-- populated with jQuery --> </tbody>
            </table>
            <h5>Valitse alemmasta taulukosta ne konseptit, jotka haluat liittää ylemmän taulukon sillattavaan kohdekonseptiin.</h5>
          </div>
          <div class="row" id="save-buttons">
            <div class="selected-original-term"><h5>Olet siltaamassa organisaatiosi konseptia: <span class="dynamic-original-term"></span><span class="dynamic-original-term-desc"></span><span class="dynamic-original-term-n"></span></h5></div>
            <div class="col-sm-12">
              <button type="button" class="btn btn-success disabled" id="btn-hyväksy">Hyväksy siltaus</button>
              <button type="button" class="btn btn-warning disabled" id="btn-manuaalinen">Manuaalinen haku</button>
              <button type="button" class="btn btn-secondary" id="btn-sulje">Sulje</button>
            </div>
          </div>
        </div>


        <!-- Reject term tab -->
        <div class="tab-pane" id="reject-tab">
          <h5>Anna selite miksi konseptia ei voida sillata</h5>
          <textarea name="Selite" id="hylkäys-syy" cols="80" rows="7"></textarea>
          <div class="row" id="save-buttons">
            <div class="selected-original-term"><h5>Olet hylkäämässä organisaatiosi konseptia: <span class="dynamic-original-term"></span><span class="dynamic-original-term-desc"></span><span class="dynamic-original-term-n"></span></h5></div>
            <div class="col-sm-12">
              <button type="button" class="btn btn-success disabled" id="btn-reject">Hylkää konsepti</button>
              <button type="button" class="btn btn-secondary" id="btn-reject-reject">Sulje</button>
            </div>
          </div>
        </div>



        <!-- Novel term tab -->
        <div class="tab-pane" id="novel-tab">
          <!-- Loading animation -->
          <div class="novel-loader">
            <div class="center spinner" id="loading-animation"></div>
          </div>

          <div class="novel-placeholder">
            <div class="help-text">
              <p>Valitse alla olevasta taulukosta se kohdekonsepti ("Uusi koodi" ja "Uusi termi" -pari), joka mielestäsi vastaa organisaatiossasi käytettyä konseptia, jota olet siltaamassa.</p>
            </div>
            <div class="row">
              <div class="selected-original-term"><h5>Olet siltaamassa organisaatiosi konseptia: <span class="dynamic-original-term"></span><span class="dynamic-original-term-desc"></span><span class="dynamic-original-term-n"></span></h5></div>
            </div>
            <table id="novel" class="table table-hover table-sm">
              <thead class="thead-light">
                <tr>
                  <th>Uusi koodi</th><th>Uusi konsepti</th><th>Uusi murre</th><th>Uusi konsepti-ID</th>
                </tr>
              </thead>
              <tbody> <!-- populated with jQuery --> </tbody>
            </table>

            <!-- embedded external components -->
            {% if target == 'Snomed CT' %}
              <div class="help-text">
                <p>Voit myös etsiä manuaalisesti sopivaa kohdekonseptia käyttämällä IHTSDO:n upotettua selainta.</p>
              </div>
              <div class="row" id="embedded-externals">
                <div class="col-sm-12">
                  <nav class="navbar navbar-expand-lg navbar-light">
                    <div class="collapse navbar-collapse">

                      <!-- Browser tabs -->
                      <ul class="nav nav-tabs mr-auto" role="tablist" id="ihtsdo-tabs">
                        <!-- <li class="nav-item"><a href="#neo4j-visu-tab" class="nav-link" data-toggle="tab" aria-expand="true">NEO4J</a></li> -->
                        <li class="nav-item"><a href="#ihtsdo-taxonomy-tab" class="nav-link" data-toggle="tab" aria-expand="true">Taxonomy</a></li>
                        <li class="nav-item active"><a href="#ihtsdo-details-tab" class="nav-link active show" data-toggle="tab" aria-expand="true">Details</a></li>
                        <li class="nav-item"><a href="#ihtsdo-search-tab" class="nav-link" data-toggle="tab" aria-expand="true">Manual Search</a></li>
                      </ul>

                      <!-- Link to external browser -->
                      <ul class="navbar-nav" id="route-to-external-buttons">
                        <li class="nav-item"><a id="ihtsdo_browser_link" target='_blank'><button type="button" class="btn btn-light" id="goto-external-browser">IHTSDO Browser (external)</button></a></li>
                      </ul>
                    </div>
                  </nav>

                  <div id="ihtsdo_browser" class="ihtsdo-browser">
                    <div class="tab-content">
                      <!-- NOTE: not yet implemented -->
                      <!-- <div class="tab-pane" id="neo4j-visu-tab"><div id="graphdb-viz"></div></div> -->
                      <div class="tab-pane" id="ihtsdo-taxonomy-tab"><div id="ihtsdo-taxonomy"></div></div>
                      <div class="tab-pane active" id="ihtsdo-details-tab"><div id="ihtsdo-details"></div></div>
                      <div class="tab-pane" id="ihtsdo-search-tab"><div id="ihtsdo-search"></div></div>
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}

            <div class="novel-similars-loader">
              <div class="center spinner" id="loading-animation"></div>
            </div>

            <div class="novel-similars-placeholder">
              <div id="novel-similars-block">
                <h5>Samankaltaisia koodeja ja termejä alkuperäisessä (organisaatiosi) koodistossa:</h5>
                <table id='novel_similar_concepts' class='table table-hover table-sm'>
                  <thead class='thead-light'>
                    <tr><th>Hyl</th><th>Huom</th><th>Organisaatiosi koodi</th><th>Organisaatiosi termi</th><th>N</th><th>Alkaen</th><th>Asti</th></tr>
                  </thead>
                  <tbody> <!-- populated with jQuery --> </tbody>
                </table>
                <h5>Valitse näistä ne, jotka haluat liittää valittuun kohdekoodiston kohdekonseptiin.</h5>
              </div>
            </div>

            <div class="row" id="save-buttons">
              <div class="selected-original-term"><h5>Olet siltaamassa organisaatiosi konseptia: <span class="dynamic-original-term"></span><span class="dynamic-original-term-desc"></span><span class="dynamic-original-term-n"></span></h5></div>
              <div class="col-sm-12">
                <button type="button" class="btn btn-secondary disabled" id="tallenna">Hyväksy siltaus</button>
                <button type="button" class="btn btn-danger" id="peru">Takaisin</button>
              </div>
            </div>
          </div>
        </div>



        <!-- Mapping info tab -->
        <div class="tab-pane" id="mapped-tab">
          <div class="row">
            <div class="col-md-12">
              <div id="mapped-concept-source-system"></div>
              <div id="mapped-concept-source"></div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <div id="mapped-concept-target-system"></div>
              <div id="mapped-concept-target"></div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <h4>Siltaustiedot:</h4><br>
              <div id="mapper-detailed-info"></div>
              <h4>Historia:</h4><br>
              <div id="mapped-concept-history"></div>
            </div>
          </div>
          <div class="row" id="save-buttons">
            <div class="col-sm-12">
              <button type="button" class="btn btn-warning" id="btn-change-mapping">Muokkaa siltausta</button>
              <button type="button" class="btn btn-secondary" id="btn-close">Sulje</button>
            </div>
          </div>
        </div>



        <!-- Note tab -->
        <div class="tab-pane" id="note-tab">
          <h5>Lisää oma kommenttisi konseptille</h5>
          <textarea name="Selite" id="konsepti-kommentti" cols="80" rows="7"></textarea>
          <div class="row" id="save-buttons">
            <div class="selected-original-term"><h5>Olet kommentoimassa organisaatiosi konseptia: <span class="dynamic-original-term"></span><span class="dynamic-original-term-desc"></span><span class="dynamic-original-term-n"></span></h5></div>
            <div class="col-sm-12">
              <button type="button" class="btn btn-success disabled" id="btn-comment">Tallenna kommentti</button>
              <button type="button" class="btn btn-secondary" id="btn-reject-comment">Sulje</button>
            </div>
          </div>
        </div>
      </div>

    <!-- Fallback if user is not logged in -->
    {% else %}
      <p>Kirjaudu sisään käyttääksesi sivuston toimintoja.</p>
    {% endif %}
  </div>
</div>






<script>
/* update progress bars */
function summarizeTable (table) {
  if (table) {
    var UserConcepts = table.rows('.table-success').count() || 0
    /* var RejectedConcepts = table.rows('.table-danger').count() || 0 */
    var BridgedConcepts = table.rows('.table-secondary').count() || 0
    var TotalConcepts = table.rows().count() || 0
    var UserPercent = UserConcepts / TotalConcepts * 100 || 0
    /* var RejectedPercent = RejectedConcepts / TotalConcepts * 100 || 0 */
    var BridgedPercent = BridgedConcepts / TotalConcepts * 100 || 0
    if (table.column(4).data()) {
      var UserSamples = table.cells('.table-success', 6).data().reduce((a, b) => Number(a) + Number(b), 0)
      /* var UserOrgSamples = table.cells('.table-primary', 5).data().reduce((a, b) => Number(a) + Number(b), 0)
      var OtherSamples = table.cells('.table-info', 5).data().reduce((a, b) => Number(a) + Number(b), 0)
      var RejectedSamples = table.cells('.table-danger', 5).data().reduce((a, b) => Number(a) + Number(b), 0) */
      var BridgedSamples = table.cells('.table-secondary', 6).data().reduce((a, b) => Number(a) + Number(b), 0)
      var TotalSamples = table.column(6).data().reduce((a, b) => Number(a) + Number(b), 0)
      var UserSamplePercent = UserSamples / TotalSamples * 100 || 0
      /* var UserOrgSamplePercent = UserOrgSamples / TotalSamples * 100 || 0
      var OtherSamplePercent = OtherSamples / TotalSamples * 100 || 0
      var RejectedSamplePercent = RejectedSamples / TotalSamples * 100 || 0 */
      var BridgedSamplePercent = BridgedSamples / TotalSamples * 100 || 0
    }

    $('#progress-user').attr('aria-valuenow', UserPercent).css('width', UserPercent + '%')
    /* $('#progress-user-organisation').attr('aria-valuenow', UserOrgPercent).css('width', UserOrgPercent + '%')
    $('#progress-other').attr('aria-valuenow', OtherPercent).css('width', OtherPercent + '%')
    $('#progress-rejected').attr('aria-valuenow', RejectedPercent).css('width', RejectedPercent + '%') */
    $('#progress-bridged').attr('aria-valuenow', BridgedPercent).css('width', BridgedPercent + '%')
    $('div#progress-text p span#progress-mapped').empty().append(UserConcepts + BridgedConcepts) /* + UserOrgConcepts + OtherConcepts + RejectedConcepts */
    $('div#progress-text p span#progress-total').empty().append(TotalConcepts)

    $('#progress-user-sample').attr('aria-valuenow', UserSamplePercent).css('width', UserSamplePercent + '%')
    /* $('#progress-user-organisation-sample').attr('aria-valuenow', UserOrgSamplePercent).css('width', UserOrgSamplePercent + '%')
    $('#progress-other-sample').attr('aria-valuenow', OtherSamplePercent).css('width', OtherSamplePercent + '%')
    $('#progress-rejected-sample').attr('aria-valuenow', RejectedSamplePercent).css('width', RejectedSamplePercent + '%') */
    $('#progress-bridged-sample').attr('aria-valuenow', BridgedSamplePercent).css('width', BridgedSamplePercent + '%')
    $('div#progress-text-sample p span#progress-mapped-sample').empty().append(UserSamples + BridgedSamples) /* + UserOrgSamples + OtherSamples + RejectedSamples */
    $('div#progress-text-sample p span#progress-total-sample').empty().append(TotalSamples)
  }
}






/* invoke IHTSDO embedded external browser */
function launchEmbeddedBrowser (conceptId, options, tab) {
  /* update embedded IHTSDO browser */
  var Taxonomies = new taxonomyPanel(document.getElementById('ihtsdo-taxonomy'), conceptId, options)
  /* var ref = new refsetPanel(document.getElementById("div-3-id"), options) */
  var Details = new conceptDetails(document.getElementById('ihtsdo-details'), conceptId, options)
  var Search = new searchPanel(document.getElementById('ihtsdo-search'), options)
  Details.subscribe(Taxonomies)
  Taxonomies.subscribe(Search)
  Details.subscribe(Search)
  Details.setupCanvas()

  /* enrich embedded browsers navigation bar with suitable attributes to inherit styling */
  $('ul#details-tabs-ihtsdo-details.nav.nav-tabs').attr('role', 'tablist')
  $('ul#details-tabs-ihtsdo-details.nav.nav-tabs > li').attr('class', 'nav-item')
  $('ul#details-tabs-ihtsdo-details.nav.nav-tabs > li > a').attr('class', 'nav-link')

  /* make detail summary main element a bit wider */
  $('#home-attributes-ihtsdo-details.col-md-offset-1.col-md-4').removeClass('col-md-4').addClass('col-md-6')

  /* hide horizontal scroll bar which shouldn't be visible */
  $('.panel.panel-default').css('overflow-x', 'hidden')

  /* align all search options buttons */
  $('div#ihtsdo-search-searchConfigBar div').css('margin-top', '5px')

  /* update external browser link with selected Snomed-CT concept ID */
  $('#ihtsdo_browser_link').attr('href', 'http://browser.ihtsdotools.org/?perspective=full&conceptId1=' +
    $(this).find('td.conceptid').text() +
    '&edition=en-edition&release=v20180731&server=http://browser.ihtsdotools.org/api/v1/snomed&langRefset=900000000000509007')

  /* external browser is hidden by default, but when CT term is selected, it should be casted */
  $('div#embedded-externals').css('display', 'block')

  /* open corresponding tab */
  $('#ihtsdo-tabs a[href="#ihtsdo-' + tab + '-tab"]').tab('show')

  /* on manual search, go to details tab when clicking search results */
  $('tbody#ihtsdo-search-resultsTable').on('click', function (e) {
    var clickedElement = e.target
    if (clickedElement.hasAttribute('data-concept-id')) {
      $('#ihtsdo-tabs a[href="#ihtsdo-details-tab"]').tab('show')

      /* when something is selected allow saving */
      $('#tallenna').removeClass('disabled').removeClass('btn-secondary').addClass('btn-success')
    }
  })
}






function getAllIndices(arr, val) {
  var indices = []
  for (var i = 0; i < arr.length; i++) {
    if (arr[i] === val) {
      indices.push(i)
    }
  }
  return indices
}






/* check original table rows if contains certain value */
function checkTableRows (tableid, d) {
  /* add tooltips if concept is commented */
  var tooltips
  $.get('_commenting').done(function (res) {
    tooltips = res

    if (d !== 0) {
      var User = []
      var UserT = []
      var Org = []
      var OrgT = []
      var Other = []
      var OtherT = []
      var Reject = []
      var RejectT = []
      var Bridged = []
      var BridgedT = []
      var i
      for (i = 0; i < d[0].length; i++) {
        User.push(d[0][i]['code_text'])
        UserT.push(d[0][i]['term_text'])
      }
      for (i = 0; i < d[1].length; i++) {
        Org.push(d[1][i]['code_text'])
        OrgT.push(d[1][i]['term_text'])
      }
      for (i = 0; i < d[2].length; i++) {
        Other.push(d[2][i]['code_text'])
        OtherT.push(d[2][i]['term_text'])
      }
      for (i = 0; i < d[3].length; i++) {
        Reject.push(d[3][i]['code_text'])
        RejectT.push(d[3][i]['term_text'])
      }
      for (i = 0; i < d[4].length; i++) {
        Bridged.push(d[4][i]['code_text'].toUpperCase())
        BridgedT.push(d[4][i]['term_text'].toUpperCase())
      }

      var h
      var cid = []
      var note = []
      for (h = 0; h < tooltips['comments'].length; h++) {
        cid.push(tooltips['comments'][h]['concept_id'])
        note.push(tooltips['comments'][h]['note'])
      }

      $(tableid).DataTable().rows().every(function (index) {
        var k = $(tableid).DataTable().row(index).data()[2]
        var t = $(tableid).DataTable().row(index).data()[3]
        var i = parseInt($(tableid).DataTable().row(index).data()[11])

        if (cid.indexOf(i) > -1) {
          $($(tableid).DataTable().row(index).node()).find('img.huom').parent().attr('data-original-title', note[cid.indexOf(i)])
          $($(tableid).DataTable().row(index).node()).find('img.huom').css('background-color', '#ff8888').css('filter', 'none').css('border-radius', '0.25rem')
        }

        if (Reject.indexOf(k) > -1 & RejectT.indexOf(t) > -1) {
          kIdx = getAllIndices(Reject, k)
          tIdx = getAllIndices(RejectT, t)
          for (var j = 0; j < kIdx.length; j++) {
            for (var m = 0; m < tIdx.length; m++) {
              if (Reject[kIdx[j]] === Reject[tIdx[m]] & RejectT[kIdx[j]] === RejectT[tIdx[m]]) {
                $($(tableid).DataTable().row(index).node()).attr('class', 'table-success')
                $($(tableid).DataTable().row(index).node()).find('img.stop').css('filter', 'grayscale(10%)')
                if ($($(tableid).DataTable().row(index).node()).find('td.status')) {
                  if ($($(tableid).DataTable().row(index).node()).find('td.status').html().length !== 0) {
                    /* TODO: this has to be optimized when more and more bridged terms are found from other organisations */
                    $.post('_mapped_info', { 'code': k, 'desc': t }).done(function (ss) {
                      var s = ss['mapd'][0]
                      $($(tableid).DataTable().row(index).node()).find('td.newcode').html('Hylätty')
                      $($(tableid).DataTable().row(index).node()).find('td.newterm').html(s[13])
                      $($(tableid).DataTable().row(index).node()).find('td.status').html(s[2] + ', ' + s[3] + ' (' + s[4] + ')')
                      $($(tableid).DataTable().row(index).node()).find('td.maptime').html(s[14])
                    })
                  }
                }
              }
            }
          }
        } else if (User.indexOf(k) > -1 & UserT.indexOf(t) > -1) {
          kIdx = getAllIndices(User, k)
          tIdx = getAllIndices(UserT, t)
          for (var j = 0; j < kIdx.length; j++) {
            for (var m = 0; m < tIdx.length; m++) {
              if (User[kIdx[j]] === User[tIdx[m]] & UserT[kIdx[j]] === UserT[tIdx[m]]) {
                $($(tableid).DataTable().row(index).node()).attr('class', 'table-success')
                if ($($(tableid).DataTable().row(index).node()).find('td.status')) {
                  if ($($(tableid).DataTable().row(index).node()).find('td.status').html().length === 0) {
                    /* TODO: this has to be optimized when more and more bridged terms are found from other organisations */
                    $.post('_mapped_info', { 'code': k, 'desc': t }).done(function (ss) {
                      var s = ss['mapd'][0]
                      $($(tableid).DataTable().row(index).node()).find('td.newcode').html(s[11])
                      $($(tableid).DataTable().row(index).node()).find('td.newterm').html(s[12])
                      $($(tableid).DataTable().row(index).node()).find('td.status').html(s[2] + ', ' + s[3] + ' (' + s[4] + ')')
                      $($(tableid).DataTable().row(index).node()).find('td.maptime').html(s[14])
                    })
                  }
                }
              }
            }
          }
        } else if (Org.indexOf(k) > -1 & OrgT.indexOf(t) > -1) {
          kIdx = getAllIndices(Org, k)
          tIdx = getAllIndices(OrgT, t)
          for (var j = 0; j < kIdx.length; j++) {
            for (var m = 0; m < tIdx.length; m++) {
              if (Org[kIdx[j]] === Org[tIdx[m]] & OrgT[kIdx[j]] === OrgT[tIdx[m]]) {
                $($(tableid).DataTable().row(index).node()).attr('class', 'table-success')
                if ($($(tableid).DataTable().row(index).node()).find('td.status')) {
                  if ($($(tableid).DataTable().row(index).node()).find('td.status').html().length === 0) {
                    /* TODO: this has to be optimized when more and more bridged terms are found from other organisations */
                    $.post('_mapped_info', { 'code': k, 'desc': t }).done(function (ss) {
                      var s = ss['mapd'][0]
                      $($(tableid).DataTable().row(index).node()).find('td.newcode').html(s[11])
                      $($(tableid).DataTable().row(index).node()).find('td.newterm').html(s[12])
                      $($(tableid).DataTable().row(index).node()).find('td.status').html(s[2] + ', ' + s[3] + ' (' + s[4] + ')')
                      $($(tableid).DataTable().row(index).node()).find('td.maptime').html(s[14])
                    })
                  }
                }
              }
            }
          }
        } else if (Other.indexOf(k) > -1 & OtherT.indexOf(t) > -1) {
          kIdx = getAllIndices(Other, k)
          tIdx = getAllIndices(OtherT, t)
          for (var j = 0; j < kIdx.length; j++) {
            for (var m = 0; m < tIdx.length; m++) {
              if (Other[kIdx[j]] === Other[tIdx[m]] & OtherT[kIdx[j]] === OtherT[tIdx[m]]) {
                $($(tableid).DataTable().row(index).node()).attr('class', 'table-secondary')
                if ($($(tableid).DataTable().row(index).node()).find('td.status')) {
                  if ($($(tableid).DataTable().row(index).node()).find('td.status').html().length === 0) {
                    /* TODO: this has to be optimized when more and more bridged terms are found from other organisations */
                    $.post('_mapped_info', { 'code': k, 'desc': t }).done(function (ss) {
                      var s = ss['mapd'][0]
                      $($(tableid).DataTable().row(index).node()).find('td.status').html(s[2] + ', ' + s[3] + ' (' + s[4] + ')')
                      $($(tableid).DataTable().row(index).node()).find('td.maptime').html(s[14])
                    })
                  }
                }
              }
            }
          }
        } else if (Bridged.indexOf(k.toUpperCase()) > -1 & BridgedT.indexOf(t.toUpperCase()) > -1) {
          kIdx = getAllIndices(Bridged, k.toUpperCase())
          tIdx = getAllIndices(BridgedT, t.toUpperCase())
          for (var j = 0; j < kIdx.length; j++) {
            for (var m = 0; m < tIdx.length; m++) {
              if (Bridged[kIdx[j]] === Bridged[tIdx[m]] & BridgedT[kIdx[j]] === BridgedT[tIdx[m]]) {
                $($(tableid).DataTable().row(index).node()).attr('class', 'table-secondary')
                $($(tableid).DataTable().row(index).node()).find('td.status').html('Bridge')
              }
            }
          }
        }
      })
    }
  })
}






function OneSelected (Target) {
  if (Target.hasClass('selected')) {
    Target.removeClass('selected')
  } else {
    Target.parent().find('tr.selected').removeClass('selected')
    Target.addClass('selected')
  }
}






function FiddleButtons () {
  if ($.fn.DataTable.isDataTable('#bridge_concepts')) {
    if ($('#bridge_concepts tbody tr').hasClass('selected')) {
      $('#btn-hyväksy').removeClass('disabled')
    } else {
      $('#btn-hyväksy').addClass('disabled')
    }
  }
}






function BoomTable (Target) {
  $(Target).DataTable().rows().remove().draw()
  $(Target).DataTable().destroy()
}






$(document).ready(function () {
  /* keyboard shortcuts: check caps-lock state (shortcuts only in use when capslock is on) */
  var caps
  document.addEventListener('keydown', function(event) {
    caps = event.getModifierState && event.getModifierState('CapsLock')
  })

  /* keyboard shortcuts: bind actions to certain keys pressed, can be one or multiple */
  $(document).on('keyup', function(e) {
    var table = $('#original').DataTable()
    if (caps === true & String.fromCharCode(e.which) === 'M') {
      table.page('next').draw('page')
    }
    if (caps === true & String.fromCharCode(e.which) === 'N') {
      table.page('previous').draw('page')
    }
  })






  /* activate tooltips */
  $("[rel='tooltip']").tooltip({ html: true, delay: {show: 0, hide: 100} })






  /* mark rows that are already mapped (should override the auto-bridged rows) */
  $.get('_checker').done(function (d) {
    /* make tables nicer with jQuery DataTable */
    var OrderingColumn = 6
    var HiddenColumn = 11
    $('#original').DataTable({
      'order': [[ OrderingColumn, 'desc' ]],
      stateSave: false,
      'search': { 'regex': true },
      'pageLength': 25,
      'language': { 'url': "{{ url_for('static', filename='js/akheron/Finnish.json') }}" },
      select: {
        style: 'os',
        selector: 'td:first-child'
      },
      'columnDefs': [{
        'targets': [ HiddenColumn ],
        'visible': false,
        'searchable': false
      }, {
        'targets': [0, 1, 6, 7, 8, 10],
        'searchable': false
      }]
    })

    checkTableRows('#original', d)

    /* neat loading animation */
    var table = $('#original').DataTable()
    table.on('draw', function () {
      $('div.loader').css({ opacity: 0, transition: 'opacity 0.5s' }).slideUp(1000)
      $('div.original-placeholder').slideDown(1000)
    })

    /* update progress bar */
    summarizeTable(table)
  })






  /* IHTSDO SNOMED-CT Browser API settings */
  var options = {
    serverUrl: 'http://browser.ihtsdotools.org/api/v1/snomed',
    edition: 'en-edition',
    release: 'v20180731',
    showIds: false,
    hideNotAcceptable: true,
    displayInactiveDescriptions: false,
    displaySynonyms: true,
    selectedView: 'inferred',
    displayChildren: false,
    langRefset: ['900000000000509007'],
    closeButton: false,
    collapseButton: false,
    linkerButton: true,
    subscribersMarker: true,
    searchMode: 'partialMatching',
    searchLang: 'english',
    diagrammingMarkupEnabled: false,
    statusSearchFilter: 'activeOnly',
    highlightByEffectiveTime: 'false'
  }






  /* activate button when something is typed */
  $('#hylkäys-syy').on('input', function () {
    $('#btn-reject').removeClass('disabled')
  })






  $('#btn-reject').on('click', function (e) {
    e.preventDefault()

    if (!$('#btn-reject').hasClass('disabled')) {
      /* find out which concept row triggered modal window */
      var clickedRow = ''
      if (!$.fn.DataTable.isDataTable('#similar_concepts')) {
        clickedRow = $('#original').find('tr.selected')
      } else {
        clickedRow = $('#similar_concepts').find('tr.selected')
      }

      /* loading animation */
      clickedRow.find('div.img-loader').show()
      clickedRow.find('#stop-sign').css('display', 'none')

      /* do the mapping */
      var code = clickedRow.find('td.oldcode').text()
      var desc = clickedRow.find('td.oldterm').text()
      var comment = $('#hylkäys-syy').val() || ''

      $.post('_event', { 'old_code': code, 'old_term': desc, 'comment': comment }).done(function () {
        $('#btn-reject').html('Tallennetaan ...').addClass('btn-secondary').removeClass('btn-success')
        if (!$('#btn-reject').hasClass('disabled')) {
          $('#btn-reject').addClass('disabled')
        }
        if (!$('#btn-reject-reject').hasClass('disabled')) {
          $('#btn-reject-reject').addClass('disabled')
        }

        /* mark rows that are already mapped */
        $.get('_checker').done(function (d) {
          checkTableRows('#original', d)

          clickedRow.find('div.img-loader').hide()
          clickedRow.find('#stop-sign').css('display', 'block')
          clickedRow.removeClass('table-light')
          clickedRow.addClass('table-danger')
          clickedRow.find('img.stop').css('filter', 'grayscale(10%)')

          /* redirect to Original tab */
          $('#original-tabs a[href="#original-tab"]').tab('show')

          /* reset modal */
          $('#hylkäys-syy').val('')
          $('#btn-reject').removeClass('disabled').removeClass('btn-secondary').addClass('btn-success')
          $('#btn-reject').html('Hylkää konsepti')
          if ($('#btn-reject-reject').hasClass('disabled')) {
            $('#btn-reject-reject').removeClass('disabled')
          }

          /* update progress bar */
          summarizeTable($('#original').DataTable())
        })
      })
    }
  })






  $('#btn-reject-reject').on('click', function (e) {
    e.preventDefault()

    /* redirect to Original tab */
    $('#original-tabs a[href="#original-tab"]').tab('show')

    $('#hylkäys-syy').val('')
    if (!$('#btn-reject').hasClass('disabled')) {
      $('#btn-reject').addClass('disabled')
    }
  })






  /* activate button when something is typed */
  $('#konsepti-kommentti').on('input', function () {
    $('#btn-comment').removeClass('disabled')
  })






  $('#btn-comment').on('click', function (e) {
    e.preventDefault()

    if (!$('#btn-comment').hasClass('disabled')) {
      /* find out which concept row triggered modal window */
      var clickedRow = ''
      if (!$.fn.DataTable.isDataTable('#similar_concepts')) {
        clickedRow = $('#original').find('tr.selected')
      } else {
        clickedRow = $('#similar_concepts').find('tr.selected')
      }

      /* loading animation */
      clickedRow.find('div.img-loader').show()
      clickedRow.find('#huom-sign').css('display', 'none')

      /* do the mapping */
      var conceptId = $('#original').DataTable().row($(clickedRow)).data()[11]
      var comment = $('#konsepti-kommentti').val() || ''

      $.post('_commenting', { 'concept_id': conceptId, 'comment': comment }).done(function () {
        $('#btn-comment').html('Tallennetaan ...').addClass('btn-secondary').removeClass('btn-success')
        if (!$('#btn-comment').hasClass('disabled')) {
          $('#btn-comment').addClass('disabled')
        }
        if (!$('#btn-reject-comment').hasClass('disabled')) {
          $('#btn-reject-comment').addClass('disabled')
        }

        /* mark rows that are already mapped */
        $.get('_checker').done(function (d) {
          checkTableRows('#original', d)

          clickedRow.find('div.img-loader').hide()
          clickedRow.find('#huom-sign').css('display', 'block')
          /*clickedRow.removeClass('table-light')
          clickedRow.addClass('table-danger')
          clickedRow.find('img.stop').css('filter', 'grayscale(10%)')*/

          /* redirect to Original tab */
          $('#original-tabs a[href="#original-tab"]').tab('show')

          /* reset modal */
          $('#konsepti-kommentti').val('')
          $('#btn-comment').removeClass('disabled').removeClass('btn-secondary').addClass('btn-success')
          $('#btn-comment').html('Tallenna kommentti')
          if ($('#btn-reject-comment').hasClass('disabled')) {
            $('#btn-reject-comment').removeClass('disabled')
          }

          /* update progress bar */
          summarizeTable($('#original').DataTable())
        })
      })
    }
  })






  $('#btn-reject-comment').on('click', function (e) {
    e.preventDefault()

    /* redirect to Original tab */
    $('#original-tabs a[href="#original-tab"]').tab('show')

    $('#konsepti-kommentti').val('')
    if (!$('#btn-comment').hasClass('disabled')) {
      $('#btn-comment').addClass('disabled')
    }
  })






  /* original term tab: unmapped terms on-click event */
  $('#original tbody').on('click', 'tr.table-light', function (e) {
    e.preventDefault()

    var $cell = $(e.target).closest('img')
    if ($cell.index() === 0) {
      if ($cell.attr('id') === 'stop-sign') {
        /* allow only one row to be selected */
        OneSelected($(this))

        if ($(this).hasClass('table-light')) {
          /* redirect to rejecting tab */
          $('#original-tabs a[href="#reject-tab"]').tab('show')

          /* get original code and term */
          var code = $(this).find('td.oldcode').text()
          var desc = $(this).find('td.oldterm').text()
          var n = $(this).find('td.n').text()

          $('#reject-tab span.dynamic-original-term').empty().append(code)
          $('#reject-tab span.dynamic-original-term-desc').empty().append(desc)
          $('#reject-tab span.dynamic-original-term-n').empty().append(' (N=' + n + ')')
        }
      } else if ($cell.attr('id') === 'huom-sign') {
        /* allow only one row to be selected */
        OneSelected($(this))

        if ($(this).hasClass('table-light')) {
          /* redirect to rejecting tab */
          $('#original-tabs a[href="#note-tab"]').tab('show')

          /* get original code and term */
          var code = $(this).find('td.oldcode').text()
          var desc = $(this).find('td.oldterm').text()
          var n = $(this).find('td.n').text()

          $('#note-tab span.dynamic-original-term').empty().append(code)
          $('#note-tab span.dynamic-original-term-desc').empty().append(desc)
          $('#note-tab span.dynamic-original-term-n').empty().append(' (N=' + n + ')')

          var conceptId = $('#original').DataTable().row($(this)).data()[11]
        }
      }
    } else {
      /* flush Novel table */
      BoomTable('#novel')
      BoomTable('#novel_similar_concepts')

      /* allow only one row to be selected */
      OneSelected($(this))

      /* get original code and term */
      var code = $(this).find('td.oldcode').text()
      var desc = $(this).find('td.oldterm').text()
      var n = $(this).find('td.n').text()

      /* return possible novel terms from database */
      $.post('_fuzzymatch', { code, desc }).done(function (Matches) {
        /* populate table */
        for (var i = 0; i < Matches['matched'].length; i++) {
          var k = Matches['matched'][i]
          $('#novel tbody').append("<tr class='table-light'>" +
            "<td class='newcode'>" + k[0] + '</td>' +
            "<td class='newterm'>" + k[1] + '</td>' +
            '<td>' + k[2] + '</td>' +
            '<td>' + k[3] + '</td>' +
            '</tr>')
        }

        /* invoke DataTable object */
        $('#novel').DataTable({
          'order': [[ 1, 'asc' ]],
          'pageLength': 10,
          'language': { 'url': "{{ url_for('static', filename='js/akheron/Finnish.json') }}" },
          'columnDefs': [{
            'targets': [ 0, 3 ],
            'visible': false,
            'searchable': false
          }],
          'rowGroup': { 'dataSrc': 0 }
        })

        /* show search panel */
        launchEmbeddedBrowser('', options, 'search')

        /* which similar terms are found from pathology data */
        $.post('_similars', { code, desc }).done(function (Matches) {
          if (Matches['similar'].length > 0) {
            for (var j = 0; j < Matches['similar'].length; j++) {
              var m = Matches['similar'][j]

              $('#novel_similar_concepts tbody').append("<tr class='table-light'>" +
                "<td class='hylkää'><img src='{{ url_for('static', filename='images/Stop_hand_caution.svg') }}' class='scaled-icon stop' alt='N/A' id='stop-sign'><div class='img-loader'><div class='center img-spinner' id='image-loading-animation'></div></div></td>" +
                "<td class='huomio'><img src='{{ url_for('static', filename='images/Pen_-_The_Noun_Project.svg') }}' class='scaled-icon huom' alt='Huom' id='huom-sign'><div class='img-loader'><div class='center img-spinner' id='image-loading-animation'></div></div></td>" +
                "<td class='oldcode'>" + m['code_text'] + '</td>' +
                "<td class='oldterm'>" + m['term_text'] + '</td>' +
                "<td class='n'>" + m['obs_number'] + '</td>' +
                "<td class='alkaen'>" + m['first_obs_date'] + '</td>' +
                "<td class='asti'>" + m['last_obs_date'] + '</td>' +
                '</tr>')

              /* on last iteration, transform table to DataTable object */
              if (j === Matches['similar'].length - 1) {
                $('#novel_similar_concepts').DataTable({
                  'order': [[ 4, 'desc' ]],
                  'pageLength': 10,
                  'language': { 'url': "{{ url_for('static', filename='js/akheron/Finnish.json') }}" }
                })
                $.get('_checker').done(function (d) {
                  checkTableRows('#novel_similar_concepts', d)
                })
              }
            }
          }
          $('#novel-tab span.dynamic-original-term').empty().append(code)
          $('#novel-tab span.dynamic-original-term-desc').empty().append(desc)
          $('#novel-tab span.dynamic-original-term-n').empty().append(' (N=' + n + ')')

          $('div.novel-loader').css({ opacity: 0, transition: 'opacity 0.5s' }).slideUp(1000)
          $('div.novel-placeholder').slideDown(1000)
        }).fail(function () {
          /* TODO: proper failing */
          window.alert('something went wrong')
        }).always(function () {
          $('div.novel-similars-loader').css({ opacity: 0, transition: 'opacity 0.5s' }).slideUp(1000)
          $('div.novel-similars-placeholder').slideDown(1000)
        })
      }).fail(function () {
        /* TODO: proper failing */
        window.alert('something went wrong')
      })

      /* redirect to Novel tab */
      $('#original-tabs a[href="#novel-tab"]').tab('show')
    }
  })






  $('#novel_similar_concepts tbody').on('click', 'tr', function (e) {
    e.preventDefault()

    var $cell = $(e.target).closest('img')
    if ($cell.index() === 0 & !$(this).hasClass('selected')) {
      /* allow only one row to be selected */
      OneSelected($(this))

      if ($(this).hasClass('table-light')) {
        /* redirect to rejecting tab */
        $('#original-tabs a[href="#reject-tab"]').tab('show')

        /* get original code and term */
        var code = $(this).find('td.oldcode').text()
        var desc = $(this).find('td.oldterm').text()
        var n = $(this).find('td.n').text()

        $('#reject-tab span.dynamic-original-term').empty().append(code)
        $('#reject-tab span.dynamic-original-term-desc').empty().append(desc)
        $('#reject-tab span.dynamic-original-term-n').empty().append(' (N=' + n + ')')
      } else if ($(this).hasClass('table-danger')) {
        $(this).find('div.img-loader').show()
        $(this).find('#stop-sign').css('display', 'none')

        var code = $(this).find('td.oldcode').text()
        var desc = $(this).find('td.oldterm').text()

        /* do the mapping */
        $.post('_event', { 'old_code': code, 'old_term': desc }).done(function () {
          /* mark rows that are already mapped */
          $.get('_checker').done(function (d) {
            checkTableRows('#original', d)

            /* update progress bar */
            summarizeTable($('#original').DataTable())
            /* redirect to Original tab */
            $('#original-tabs a[href="#original-tab"]').tab('show')
          })
        }).fail(function () {
          /* TODO: proper failing */
          window.alert('something went wrong')
        })
      }
    }

    if ($cell.index() !== 0) {
    /*if ($cell.index() !== 0 & $(this).hasClass('table-light')) {*/
      $(this).toggleClass('selected')
    }
  })






  /* Novel tab: fetched fuzzymatch terms on-click event */
  $('#novel tbody').on('click', 'tr.table-light', function (e) {
    e.preventDefault()

    /* allow only one row to be selected */
    OneSelected($(this))

    /* when something is selected allow saving and going to external IHTSDO browser */
    $('#tallenna').removeClass('disabled').removeClass('btn-secondary').addClass('btn-success')
    $('#ihtsdo_button').removeClass('disabled').removeClass('btn-secondary').addClass('btn-info')

    /* show embedded browser with additional details and optional search functionality */
    if ($(this).find('td.newterm').text()) {
      launchEmbeddedBrowser($(this).prev('tr.group').find('td').text(), options, 'details')
    } else {
      /* exception if no code can be found */
      launchEmbeddedBrowser('', options, 'search')
    }
  })






  /* Novel tab: if nothing is returned (result table is empty) */
  $('#novel tbody').on('click', 'td.dataTables_empty', function (e) {
    e.preventDefault()

    /* show embedded browser with manual search functionality */
    launchEmbeddedBrowser('', options, 'search')
  })






  /* Novel tab: table adjust */
  $(document).on('shown.bs.tab', 'a[data-toggle="tab"]', function (e) {
    $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust()
  })






  $('#tallenna').on('click', function (e) {
    e.preventDefault()

    if (!$('#tallenna').hasClass('disabled')) {
      /* change save button */
      $('#tallenna').addClass('disabled')

      /* find selected term */
      var oc = $('#novel-tab span.dynamic-original-term').text()
      var ot = $('#novel-tab span.dynamic-original-term-desc').text()
      var nc = $('#home-attributes-ihtsdo-details h5 #copy-content-custom').text().split('|')[0].trim()
      var nt = $('#home-attributes-ihtsdo-details h5 #copy-content-custom').text().split('|')[1].trim()

      $.post('_event', { 'old_code': oc, 'old_term': ot, 'new_code': nc, 'new_term': nt }).done(function () {
        $('#tallenna').html('Tallennetaan ...').addClass('btn-secondary').removeClass('btn-success')
        $('#peru').addClass('disabled')

        /* find out if similar concepts is present */
        if ($.fn.DataTable.isDataTable('#novel_similar_concepts') & $('#novel_similar_concepts tbody tr.selected').length > 0) {
          var SimCon = $('#novel_similar_concepts tbody tr.selected')

          /* find out which original concepts are to be mapped to the selected novel concept */
          SimCon.each(function (idx) {
            var s2 = $(this).find('td.oldcode').text()
            var s2d = $(this).find('td.oldterm').text()

            /* find out when is the last iteration of the loop */
            var isLastElement = idx === SimCon.length - 1

            /* do the mapping */
            $.post('_event', { 'old_code': s2, 'old_term': s2d, 'new_code': nc, 'new_term': nt }).done(function () {
              /* update main original concepts table on last iteration */
              if (isLastElement) {
                /* mark rows that are already mapped */
                setTimeout(function() {
                  $.get('_checker').done(function (d) {
                    checkTableRows('#original', d)

                    /* redirect to Original tab */
                    $('#original-tabs a[href="#original-tab"]').tab('show')

                    /* hide external browser */
                    $('div#embedded-externals').css('display', 'none')

                    /* flush Novel tables */
                    BoomTable('#novel')
                    BoomTable('#novel_similar_concepts')
                    $('#novel-tab span.dynamic-original-term').empty()
                    $('#novel-tab span.dynamic-original-term-desc').empty()
                    $('#novel-tab span.dynamic-original-term-n').empty()

                    /* bring back loading animation */
                    $('div.novel-similars-loader').css({ display: '', opacity: '', transition: '' })
                    $('div.novel-similars-placeholder').css('display', 'none')
                    $('div.novel-loader').css({ display: '', opacity: '', transition: '' })
                    $('div.novel-placeholder').css('display', 'none')

                    /* change save button */
                    $('#tallenna').removeClass('disabled').removeClass('btn-secondary').addClass('btn-success')
                    $('#tallenna').html('Hyväksy siltaus')
                    $('#peru').removeClass('disabled')

                    /* update progress bar */
                    summarizeTable($('#original').DataTable())
                  })
                }, 800)
              }
            }).fail(function () {
              /* TODO: proper failing */
              window.alert('something went wrong')
            })
          })
        } else {
          /* mark rows that are already mapped */
          $.get('_checker').done(function (d) {
            checkTableRows('#original', d)

            /* redirect to Original tab */
            $('#original-tabs a[href="#original-tab"]').tab('show')

            /* hide external browser */
            $('div#embedded-externals').css('display', 'none')

            /* flush Novel table */
            BoomTable('#novel')
            BoomTable('#novel_similar_concepts')
            $('#novel-tab span.dynamic-original-term').empty()
            $('#novel-tab span.dynamic-original-term-desc').empty()
            $('#novel-tab span.dynamic-original-term-n').empty()

            /* bring back loading animation */
            $('div.novel-similars-loader').css({ display: '', opacity: '', transition: '' })
            $('div.novel-similars-placeholder').css('display', 'none')
            $('div.novel-loader').css({ display: '', opacity: '', transition: '' })
            $('div.novel-placeholder').css('display', 'none')

            /* change save button */
            $('#tallenna').removeClass('disabled').removeClass('btn-secondary').addClass('btn-success')
            $('#tallenna').html('Hyväksy siltaus')
            $('#peru').removeClass('disabled')

            /* update progress bar */
            summarizeTable($('#original').DataTable())
          })
        }
      }).fail(function () {
        /* TODO: proper failing */
        window.alert('something went wrong')
      })
    }
  })






  /* "Peru" button function */
  $('#peru').on('click', function(e) {
    e.preventDefault()

    /* redirect to Original tab */
    $('#original-tabs a[href="#original-tab"]').tab('show')

    /* hide external browser */
    $('div#embedded-externals').css('display', 'none')

    /* flush Novel table */
    BoomTable('#novel')
    BoomTable('#novel_similar_concepts')
    $('#novel-tab span.dynamic-original-term').empty()
    $('#novel-tab span.dynamic-original-term-desc').empty()
    $('#novel-tab span.dynamic-original-term-n').empty()

    /* bring back loading animation */
    $('div.novel-similars-loader').css({ display: '', opacity: '', transition: '' })
    $('div.novel-similars-placeholder').css('display', 'none')
    $('div.novel-loader').css({ display: '', opacity: '', transition: '' })
    $('div.novel-placeholder').css('display', 'none')

    /* clear neo4j visualisation */
    /* if (viz) {
      viz.clearNetwork()
    } */
  })






  /* Original tab: bridged terms on-click event */
  $('#original tbody').on('click', 'tr.table-secondary', function (e) {
    e.preventDefault()

    var $cell = $(e.target).closest('img')
    if ($cell.index() === 0) {
      if ($cell.attr('id') === 'stop-sign') {
        /* allow only one row to be selected */
        OneSelected($(this))

        if ($(this).hasClass('table-secondary')) {
          /* redirect to rejecting tab */
          $('#original-tabs a[href="#reject-tab"]').tab('show')

          /* get original code and term */
          var code = $(this).find('td.oldcode').text()
          var desc = $(this).find('td.oldterm').text()
          var n = $(this).find('td.n').text()

          $('#reject-tab span.dynamic-original-term').empty().append(code)
          $('#reject-tab span.dynamic-original-term-desc').empty().append(desc)
          $('#reject-tab span.dynamic-original-term-n').empty().append(' (N=' + n + ')')
        }
      } else if ($cell.attr('id') === 'huom-sign') {
        /* allow only one row to be selected */
        OneSelected($(this))

        if ($(this).hasClass('table-secondary')) {
          /* redirect to rejecting tab */
          $('#original-tabs a[href="#note-tab"]').tab('show')

          /* get original code and term */
          var code = $(this).find('td.oldcode').text()
          var desc = $(this).find('td.oldterm').text()
          var n = $(this).find('td.n').text()

          $('#note-tab span.dynamic-original-term').empty().append(code)
          $('#note-tab span.dynamic-original-term-desc').empty().append(desc)
          $('#note-tab span.dynamic-original-term-n').empty().append(' (N=' + n + ')')

          var conceptId = $('#original').DataTable().row($(this)).data()[11]
        }
      }
    } else {
      /* allow only one row to be selected */
      OneSelected($(this))

      /* flush tables */
      BoomTable('#bridge_concepts')
      BoomTable('#similar_concepts')

      /* allow manual search */
      $('#btn-manuaalinen').removeClass('disabled')

      /* find concept in focus */
      var code = $(this).find('td.oldcode').text()
      var desc = $(this).find('td.oldterm').text()
      var n = $(this).find('td.n').text()

      /* update concept code and term */
      $('#accept-tab span.dynamic-original-term').empty().append(code)
      $('#accept-tab span.dynamic-original-term-desc').empty().append(desc)
      $('#accept-tab span.dynamic-original-term-n').empty().append(' (N=' + n + ')')

      /* look for terms that are matched automatically */
      $.post('_autobridged', { code, desc }).done(function (Matches) {
        for (var i = 0; i < Matches['bridged'].length; i++) {
          var k = Matches['bridged'][i]

          $('#bridge_concepts tbody').append("<tr class='table-light'>" +
            "<td class='oldcode'>" + k['source_code_text'] + '</td>' +
            "<td class='oldterm'>" + k['source_term_text'] + '</td>' +
            "<td class='newcode'>" + k['destination_code_text'] + '</td>' +
            "<td class='newterm'>" + k['destination_term_text'] + '</td>' +
            '</tr>')

          /* on last iteration, transform table to DataTable object */
          if (i === Matches['bridged'].length - 1) {
            $('#bridge_concepts').DataTable({
              'pageLength': 10,
              'language': { 'url': "{{ url_for('static', filename='js/akheron/Finnish.json') }}" }
            })

            /* if only one novel concept is retrieved, then mark it selected by default */
            if ($('#bridge_concepts').DataTable().rows().count() === 1) {
              $('#bridge_concepts tbody tr').addClass('selected')
              $('#btn-hyväksy').removeClass("disabled")
            }

            /* which similar terms are found from pathology data */
            for (var j = 0; j < Matches['similar'].length; j++) {
              var m = Matches['similar'][j]

              $('#similar_concepts tbody').append("<tr class='table-light'>" +
                "<td class='hylkää'><img src='{{ url_for('static', filename='images/Stop_hand_caution.svg') }}' class='scaled-icon stop' alt='N/A' id='stop-sign'><div class='img-loader'><div class='center img-spinner' id='image-loading-animation'></div></div></td>" +
                "<td class='huomio'><img src='{{ url_for('static', filename='images/Pen_-_The_Noun_Project.svg') }}' class='scaled-icon huom' alt='Huom' id='huom-sign'><div class='img-loader'><div class='center img-spinner' id='image-loading-animation'></div></div></td>" +
                "<td class='oldcode'>" + m['code_text'] + '</td>' +
                "<td class='oldterm'>" + m['term_text'] + '</td>' +
                "<td class='n'>" + m['obs_number'] + '</td>' +
                "<td class='newcode'>" + m['destination_code_text'] + '</td>' +
                "<td class='newterm'>" + m['destination_term_text'] + '</td>' +
                '</tr>')

              /* on last iteration, transform table to DataTable object */
              if (j === Matches['similar'].length - 1) {

                $('#similar_concepts').DataTable({
                  'pageLength': 10,
                  'language': { 'url': "{{ url_for('static', filename='js/akheron/Finnish.json') }}" },
                  'initComplete': function (settings, json) {
                    /*modalResize('#acceptModal.modal-dialog.modal-content')*/
                  }
                })

                /* activate/deactivate button */
                FiddleButtons()
              }
            }
          }
        }
      }).fail(function () {
        /* TODO: proper failing */
        window.alert('something went wrong')
      })
      /* redirect to accepting tab */
      $('#original-tabs a[href="#accept-tab"]').tab('show')
    }
  })






  $('#similar_concepts tbody').on('click', 'tr', function (e) {
    e.preventDefault()

    var $cell = $(e.target).closest('img')
    if ($cell.index() === 0 & !$(this).hasClass('selected')) {
      if ($cell.attr('id') === 'stop-sign') {
        /* allow only one row to be selected */
        OneSelected($(this))

        if ($(this).hasClass('table-light')) {
          /* redirect to rejecting tab */
          $('#original-tabs a[href="#reject-tab"]').tab('show')

          /* get original code and term */
          var code = $(this).find('td.oldcode').text()
          var desc = $(this).find('td.oldterm').text()
          var n = $(this).find('td.n').text()

          $('#reject-tab span.dynamic-original-term').empty().append(code)
          $('#reject-tab span.dynamic-original-term-desc').empty().append(desc)
          $('#reject-tab span.dynamic-original-term-n').empty().append(' (N=' + n + ')')
        } else if ($(this).hasClass('table-danger')) {
          $(this).find('div.img-loader').show()
          $(this).find('#stop-sign').css('display', 'none')

          var code = $(this).find('td.oldcode').text()
          var desc = $(this).find('td.oldterm').text()

          /* do the mapping */
          $.post('_event', { 'old_code': code, 'old_term': desc }).done(function () {
            /* mark rows that are already mapped */
            $.get('_checker').done(function (d) {
              checkTableRows('#original', d)

              /* update progress bar */
              summarizeTable($('#original').DataTable())

              /* redirect to Original tab */
              $('#original-tabs a[href="#original-tab"]').tab('show')
            })
          }).fail(function () {
            /* TODO: proper failing */
            window.alert('something went wrong')
          })
        }
      } else if ($cell.attr('id') === 'huom-sign') {
        /* allow only one row to be selected */
        OneSelected($(this))

        if ($(this).hasClass('table-light')) {
          /* redirect to rejecting tab */
          $('#original-tabs a[href="#note-tab"]').tab('show')

          /* get original code and term */
          var code = $(this).find('td.oldcode').text()
          var desc = $(this).find('td.oldterm').text()
          var n = $(this).find('td.n').text()

          $('#note-tab span.dynamic-original-term').empty().append(code)
          $('#note-tab span.dynamic-original-term-desc').empty().append(desc)
          $('#note-tab span.dynamic-original-term-n').empty().append(' (N=' + n + ')')

          var conceptId = $('#original').DataTable().row($(this)).data()[11]
        }
      }
    }

    if ($cell.index() !== 0 & $(this).hasClass('table-light')) {
      $(this).toggleClass('selected')

      /* activate/deactivate button */
      FiddleButtons()
    }
  })






  /* "Manuaalinen haku" button function */
  $('#btn-manuaalinen').on('click', function(e) {
    e.preventDefault()

    var searchTable = $('#original tbody tr.selected')
    var code = searchTable.find('td.oldcode').text()
    var desc = searchTable.find('td.oldterm').text()
    var n = searchTable.find('td.n').text()

    /* transfer selected original term to Novel tab */
    $('#novel-tab span.dynamic-original-term').empty().append(code)
    $('#novel-tab span.dynamic-original-term-desc').empty().append(desc)
    $('#novel-tab span.dynamic-original-term-n').empty().append(' (N=' + n + ')')

    /* when something is selected allow saving and going to external IHTSDO browser */
    $('#ihtsdo_button').removeClass('disabled').removeClass('btn-secondary').addClass('btn-info')

    /* show embedded browser with additional details and optional search functionality */
    launchEmbeddedBrowser('', options, 'search')

    /* redirect to Novel tab */
    $('#original-tabs a[href="#novel-tab"]').tab('show')

    $('div.novel-similars-loader').css({ opacity: 0, transition: 'opacity 0.5s' }).slideUp(1000)
    $('div.novel-similars-placeholder').slideDown(1000)
    $('div.novel-loader').css({ opacity: 0, transition: 'opacity 0.5s' }).slideUp(1000)
    $('div.novel-placeholder').slideDown(1000)
  })






  /* bind clicking events to modal tables */
  $('#bridge_concepts tbody').on('click', 'tr', function (e) {
    e.preventDefault()

    /* allow only one row to be selected */
    OneSelected($(this))

    /* activate/deactivate button */
    FiddleButtons()
  })






  /* Original tab: rejected terms on-click event */
  $('#original tbody').on('click', 'tr.table-danger', function (e) {
    e.preventDefault()

    /* allow only one row to be selected */
    OneSelected($(this))

    var code = $(this).find('td.oldcode').text()
    var desc = $(this).find('td.oldterm').text()

    var $cell = $(e.target).closest('img')
    if ($cell.index() === 0) {
      $(this).find('div.img-loader').show()
      $(this).find('#stop-sign').css('display', 'none')

      var activeRow = $(this)
      /* do the mapping */
      $.post('_event', { 'old_code': code, 'old_term': desc, 'undo': true }).done(function () {
        /* mark rows that are already mapped */
        $.get('_checker').done(function (d) {
          checkTableRows('#original', d)
          activeRow.find('div.img-loader').hide()
          activeRow.find('#stop-sign').css('display', 'block')
          activeRow.removeClass('table-danger').addClass('table-light')
          activeRow.find('img.stop').css('filter', 'grayscale(90%)')

          /* update progress bar */
          summarizeTable($('#original').DataTable())
        })
      }).fail(function () {
        /* TODO: proper failing */
        window.alert('something went wrong')
      })
    } else {
      $('#btn-change-mapping').addClass('disabled')
      $('#mapped-concept-source-system').empty()
      $('#mapped-concept-source').empty()
      $('#mapped-concept-target-system').empty()
      $('#mapped-concept-target').empty()

      $('#mapper-detailed-info').empty()

      $.post('_mapped_info', { code, desc }).done(function (ss) {
        var s = ss['mapd']
        var SrcTitle = '<h4>Lähdekoodiston ' + s[0][5] + ' (' + s[0][6] + ') konsepti:</h4>'
        var SrcConc
        var TrgTitle
        var TrgConc

        if (s[0][9] === null) {
          SrcConc = "<button type='button' class='btn btn-danger btn-lg'><h4>" + s[0][8] + '  (' + s[0][7] + ')</h4></button>'
          TrgTitle = '<h4>Hylätty konsepti. Ei kohdekoodistoa.</h4>'
        } else {
          SrcConc = "<button type='button' class='btn btn-success btn-lg'><h4>" + s[0][8] + '  (' + s[0][7] + ')</h4></button>'
          TrgTitle = '<h4>Kohdekoodiston ' + s[0][9] + ' (' + s[0][10] + ') konsepti:</h4>'
          TrgConc = "<button type='button' class='btn btn-success btn-lg'><h4>" + s[0][12] + '  (' + s[0][11] + ')</h4></button>'
        }

        var Siltaaja = '<h5>Käyttäjä: ' + s[0][2] + ', ' + s[0][3] + ' (' + s[0][4] + ')<br>' + s[0][14] + '</h5>'
        if (s[0][13]) {
          var Kommentti = '<h5>Kommentti: ' + s[0][13] + '</h5>'
        }

        /* Populate buttons to users home page */
        $(function () {
          var SrcTitleElem = document.getElementById('mapped-concept-source-system')
          var SrcConcept = document.getElementById('mapped-concept-source')
          SrcTitleElem.innerHTML += SrcTitle
          SrcConcept.innerHTML += SrcConc

          var TrgTitleElem = document.getElementById('mapped-concept-target-system')
          var TrgConcept = document.getElementById('mapped-concept-target')
          TrgTitleElem.innerHTML += TrgTitle
          if (TrgConc) {
            TrgConcept.innerHTML += TrgConc
          }

          var MapperInfo = document.getElementById('mapper-detailed-info')
          MapperInfo.innerHTML += Siltaaja
          if (Kommentti) {
            MapperInfo.innerHTML += Kommentti
          }
        })
      })

      /* redirect to information tab */
      $('#original-tabs a[href="#mapped-tab"]').tab('show')

      /* add function to closing button */
      $('#mapped-tab button#btn-close').on('click', function (e) {
        e.preventDefault()

        /* redirect to Original tab */
        $('#original-tabs a[href="#original-tab"]').tab('show')

        $('#btn-change-mapping').removeClass('disabled')
      })
    }
  })






  /* Original tab: other organisation mapped terms on-click event */
  $('#original tbody').on('click', 'tr.table-info', function (e) {
    e.preventDefault()

    var $cell = $(e.target).closest('img')
    if ($cell.index() === 0 & !$(this).hasClass('selected')) {
      if ($(this).hasClass('table-info')) {
        /* redirect to rejecting tab */
        $('#original-tabs a[href="#reject-tab"]').tab('show')

        /* get original code and term */
        var code = $(this).find('td.oldcode').text()
        var desc = $(this).find('td.oldterm').text()
        var n = $(this).find('td.n').text()

        $('#reject-tab span.dynamic-original-term').empty().append(code)
        $('#reject-tab span.dynamic-original-term-desc').empty().append(desc)
        $('#reject-tab span.dynamic-original-term-n').empty().append(' (N=' + n + ')')
      } else if ($(this).hasClass('table-danger')) {
        $(this).find('div.img-loader').show()
        $(this).find('#stop-sign').css('display', 'none')

        var code = $(this).find('td.oldcode').text()
        var desc = $(this).find('td.oldterm').text()

        /* do the mapping */
        $.post('_event', { 'old_code': code, 'old_term': desc }).done(function () {
          /* mark rows that are already mapped */
          $.get('_checker').done(function (d) {
            checkTableRows('#original', d)

            /* update progress bar */
            summarizeTable($('#original').DataTable())
          })
        }).fail(function () {
          /* TODO: proper failing */
          window.alert('something went wrong')
        })
      } else {
        /* TODO */
      }
    } else {
      /* allow only one row to be selected */
      OneSelected($(this))

      /* flush tables */
      BoomTable('#bridge_concepts')
      BoomTable('#similar_concepts')

      /* allow manual search and accepting mapping from other organisation */
      $('#btn-manuaalinen').removeClass('disabled')

      /* find concept in focus */
      var code = $(this).find('td.oldcode').text()
      var desc = $(this).find('td.oldterm').text()
      var newc = $(this).find('td.newcode').text()
      var newt = $(this).find('td.newterm').text()
      var n = $(this).find('td.n').text()

      /* update code and term */
      $('#accept-tab span.dynamic-original-term').empty().append(code)
      $('#accept-tab span.dynamic-original-term-desc').empty().append(desc)
      $('#accept-tab span.dynamic-original-term-n').empty().append(' (N=' + n + ')')

      /* look for terms that are already mapped */
      $.post('_other_mapped', { code, desc }).done(function (Matches) {
        for (var i = 0; i < Matches['mapped'].length; i++) {
          var k = Matches['mapped'][i]

          $('#bridge_concepts tbody').append("<tr class='table-light'>" +
            "<td class='oldcode'>" + k['source_code_text'] + '</td>' +
            "<td class='oldterm'>" + k['source_term_text'] + '</td>' +
            "<td class='newcode'>" + k['destination_code_text'] + '</td>' +
            "<td class='newterm'>" + k['destination_term_text'] + '</td>' +
            '</tr>')

          /* on last iteration, transform table to DataTable object */
          if (i === Matches['mapped'].length - 1) {
            $('#bridge_concepts').DataTable({
              'pageLength': 10,
              'language': { 'url': "{{ url_for('static', filename='js/akheron/Finnish.json') }}" }
            })

            /* if only one novel concept is retrieved, then mark it selected by default */
            if ($('#bridge_concepts').DataTable().rows().count() === 1) {
              $('#bridge_concepts tbody tr').addClass('selected')
              $('#btn-hyväksy').removeClass("disabled")
            }

            /* activate/deactivate button */
            FiddleButtons()
          }
        }
      }).fail(function () {
        /* TODO: proper failing */
        window.alert('something went wrong')
      })
      /* redirect to accepting tab */
      $('#original-tabs a[href="#accept-tab"]').tab('show')
    }
  })






  /* Original tab: mapped terms on-click event (user self, or from users organisation) */
  $('#original tbody').on('click', 'tr.table-primary, tr.table-success', function (e) {
    e.preventDefault()

    /* allow only one row to be selected */
    OneSelected($(this))

    var code = $(this).find('td.oldcode').text()
    var desc = $(this).find('td.oldterm').text()

    $('#mapped-concept-source-system').empty()
    $('#mapped-concept-source').empty()
    $('#mapped-concept-target-system').empty()
    $('#mapped-concept-target').empty()
    $('#mapper-detailed-info').empty()
    $('#mapped-concept-history').empty()

    $.post('_mapped_info', { code, desc }).done(function (ss) {
      var s = ss['mapd']
      var SrcTitle = '<h4>Lähdekoodiston ' + s[0][5] + ' (' + s[0][6] + ') konsepti:</h4>'
      var TrgTitle = '<h4>Kohdekoodiston ' + s[0][9] + ' (' + s[0][10] + ') konsepti:</h4>'

      var SrcConc = "<button type='button' class='btn btn-success btn-lg'><h4>" + s[0][8] + '  (' + s[0][7] + ')</h4></button>'
      var TrgConc = "<button type='button' class='btn btn-success btn-lg'><h4>" + s[0][12] + '  (' + s[0][11] + ')</h4></button>'

      var Siltaaja = '<h5>Käyttäjä: ' + s[0][2] + ', ' + s[0][3] + ' (' + s[0][4] + ')<br>' + s[0][14] + '</h5>'
      if (s[0][13]) {
        var Kommentti = '<h5>Kommentti: ' + s[0][13] + '</h5>'
      }

      /* Populate buttons to users home page */
      $(function () {
        var SrcTitleElem = document.getElementById('mapped-concept-source-system')
        var SrcConcept = document.getElementById('mapped-concept-source')
        SrcTitleElem.innerHTML += SrcTitle
        SrcConcept.innerHTML += SrcConc

        var TrgTitleElem = document.getElementById('mapped-concept-target-system')
        var TrgConcept = document.getElementById('mapped-concept-target')
        TrgTitleElem.innerHTML += TrgTitle
        TrgConcept.innerHTML += TrgConc

        var MapperInfo = document.getElementById('mapper-detailed-info')
        MapperInfo.innerHTML += Siltaaja
        if (Kommentti) {
          MapperInfo.innerHTML += Kommentti
        }

        var ConceptHistory = document.getElementById('mapped-concept-history')
        if (ss['hist'].length > 0) {
          var h = ss['hist']
          for (var i = 0; i < h.length; i++) {
            if (h[i][14] === "User mapping") {
              ConceptHistory.innerHTML += '<h5>' + h[i][15] + ': ' + h[i][2] + ', ' + h[i][3] + ' (' + h[i][4] + ') - ' + h[i][7] + ' ' + h[i][8] + ' >>>> ' + h[i][11] + ' ' + h[i][12]
            } else if (h[i][14] === "Incorrect concept") {
              ConceptHistory.innerHTML += '<h5>' + h[i][15] + ': ' + h[i][2] + ', ' + h[i][3] + ' (' + h[i][4] + ') - ' + h[i][7] + ' ' + h[i][8] + ' is ' + h[i][14] + ': ' + h[i][13]
            }
          }
        }
      })
    })
    /* redirect to information tab */
    $('#original-tabs a[href="#mapped-tab"]').tab('show')

    /* add function to closing button */
    $('#mapped-tab button#btn-close').on('click', function (e) {
      e.preventDefault()

      /* redirect to Original tab */
      $('#original-tabs a[href="#original-tab"]').tab('show')
    })
  })






  /* TODO: this is very similar when clicking original table table-light rows, should be functionized to utilise same codes */
  $('#btn-change-mapping').on('click', function (e) {
    e.preventDefault()

    /* flush Novel table */
    BoomTable('#novel')

    /* get original code and term */
    var code = $('#original tbody tr.selected').find('td.oldcode').text()
    var desc = $('#original tbody tr.selected').find('td.oldterm').text()
    var n = $('#original tbody tr.selected').find('td.n').text()

    /* return possible novel terms from database */
    $.post('_fuzzymatch', { code, desc }).done(function (Matches) {
      /* populate table */
      for (var i = 0; i < Matches['matched'].length; i++) {
        var k = Matches['matched'][i]
        $('#novel tbody').append("<tr class='table-light'>" +
          "<td class='newcode'>" + k[0] + '</td>' +
          "<td class='newterm'>" + k[1] + '</td>' +
          '<td>' + k[2] + '</td>' +
          '<td>' + k[3] + '</td>' +
          '</tr>')
      }

      /* invoke DataTable object */
      $('#novel').DataTable({
        'order': [[ 1, 'asc' ]],
        'pageLength': 10,
        'language': { 'url': "{{ url_for('static', filename='js/akheron/Finnish.json') }}" },
        'columnDefs': [{
          'targets': [ 0, 3 ],
          'visible': false,
          'searchable': false
        }],
        'rowGroup': { 'dataSrc': 0 }
      })

      $('#novel-tab span.dynamic-original-term').empty().append(code)
      $('#novel-tab span.dynamic-original-term-desc').empty().append(desc)
      $('#novel-tab span.dynamic-original-term-n').empty().append(' (N=' + n + ')')

      /* show embedded browser with additional details and optional search functionality */
      launchEmbeddedBrowser('', options, 'search')

      $('div.novel-similars-loader').css({ opacity: 0, transition: 'opacity 0.5s' }).slideUp(1000)
      $('div.novel-similars-placeholder').slideDown(1000)
      $('div.novel-loader').css({ opacity: 0, transition: 'opacity 0.5s' }).slideUp(1000)
      $('div.novel-placeholder').slideDown(1000)

      /* redirect to Novel tab */
      $('#original-tabs a[href="#novel-tab"]').tab('show')
    }).fail(function () {
      /* TODO: proper failing */
      window.alert('something went wrong')
    })
  })






  /* bind events to modal buttons */
  $('#btn-hyväksy').on('click', function (e) {
    e.preventDefault()

    if (!$('#btn-hyväksy').hasClass('disabled')) {
      var BrCon = $('#bridge_concepts tbody tr.selected')

      /* find out which novel concept was selected */
      var ct = BrCon.find('td.newcode').text()
      var ctn = BrCon.find('td.newterm').text()

      /* find out which original concept was selected */
      var cto = BrCon.find('td.oldcode').text()
      var ctno = BrCon.find('td.oldterm').text()

      /* do the mapping */
      $.post('_event', { 'old_code': cto, 'old_term': ctno, 'new_code': ct, 'new_term': ctn }).done(function () {
        $('#btn-hyväksy').html('Tallennetaan ...').addClass('btn-secondary').removeClass('btn-success')
        if (!$('#btn-hyväksy').hasClass('disabled')) {
          $('#btn-hyväksy').addClass('disabled')
        }
        if (!$('#btn-manuaalinen').hasClass('disabled')) {
          $('#btn-manuaalinen').addClass('disabled')
        }
        if (!$('#btn-sulje').hasClass('disabled')) {
          $('#btn-sulje').addClass('disabled')
        }

        /* mark rows that are already mapped */
        $.get('_checker').done(function (d) {
          checkTableRows('#original', d)

          /* update progress bar */
          summarizeTable($('#original').DataTable())

          /* redirect to Original tab */
          $('#original-tabs a[href="#original-tab"]').tab('show')

          /* change save button */
          $('#btn-hyväksy').removeClass('disabled').removeClass('btn-secondary').addClass('btn-success')
          $('#btn-hyväksy').html('Hyväksy siltaus')
          $('#btn-sulje').removeClass('disabled')
          $('#similars-block').css("display", "block")
        })
      }).fail(function () {
        /* TODO: proper failing */
        window.alert('something went wrong')
      })

      /* find out if similar concepts is present */
      if ($.fn.DataTable.isDataTable('#similar_concepts')) {
        var SimCon = $('#similar_concepts tbody tr.selected')

        /* find out which original concepts are to be mapped to the selected novel concept */
        SimCon.each(function (idx) {
          var s2 = $(this).find('td.oldcode').text()
          var s2d = $(this).find('td.oldterm').text()

          /* find out when is the last iteration of the loop */
          var isLastElement = idx === SimCon.length - 1

          /* do the mapping */
          $.post('_event', { 'old_code': s2, 'old_term': s2d, 'new_code': ct, 'new_term': ctn }).done(function () {
            $('#btn-hyväksy').html('Tallennetaan ...').addClass('btn-secondary').removeClass('btn-success')
            if (!$('#btn-hyväksy').hasClass('disabled')) {
              $('#btn-hyväksy').addClass('disabled')
            }
            if (!$('#btn-manuaalinen').hasClass('disabled')) {
              $('#btn-manuaalinen').addClass('disabled')
            }
            if (!$('#btn-sulje').hasClass('disabled')) {
              $('#btn-sulje').addClass('disabled')
            }

            /* update main original concepts table on last iteration */
            if (isLastElement) {
              /* mark rows that are already mapped */
              $.get('_checker').done(function (d) {
                checkTableRows('#original', d)

                /* update progress bar */
                summarizeTable($('#original').DataTable())

                /* redirect to Original tab */
                $('#original-tabs a[href="#original-tab"]').tab('show')

                /* change save button */
                $('#btn-hyväksy').removeClass('disabled').removeClass('btn-secondary').addClass('btn-success')
                $('#btn-hyväksy').html('Hyväksy siltaus')
                $('#btn-sulje').removeClass('disabled')
              })
            }
          }).fail(function () {
            /* TODO: proper failing */
            window.alert('something went wrong')
          })
        })
      }
    }
  })






  /* "Sulje" button */
  $('#accept-tab button#btn-sulje').on('click', function (e) {
    e.preventDefault()

    /* flush tables */
    BoomTable('#bridge_concepts')
    BoomTable('#similar_concepts')
    /* redirect to Original tab */
    $('#original-tabs a[href="#original-tab"]').tab('show')

    /* make buttons unclickable */
    $('#btn-hyväksy').addClass('disabled')
    $('#btn-manuaalinen').addClass('disabled')
  })






  /* filtering buttons */
  $('#filtering-buttons > li > button').click(function () {
    /* disable button for a moment to prevent double-clicking */
    var Btns = $('#filtering-buttons > li > button')
    for (var i = 0; i < Btns.length; i++) {
      $(Btns[i]).prop('disabled', true)
      setTimeout(function (btn) { btn.prop('disabled', false) }, 800, $(Btns[i]))
    }

    /* catch DOM */
    var tabl = $('#original').DataTable()
    var ClickedId = $(this).attr('id')
    var hiddenRow = {}

    /* if filter is active, deactivate filtering */
    if ($(this).hasClass('active')) {
      $(this).removeClass('active')
      $.fn.dataTable.ext.search.pop()

      /* find out current position on table before redrawing */
      if (!tabl.rows({ page: 'current' })[0][0]) {
        var toprow = hiddenRow.hideRows
      }
      else if (!toprow) {
        var toprow = tabl.rows({ page: 'current' })[0][0]
      }

      /* apply un-filtering and update table */
      tabl.draw()

      /* check if top row is still on visible page of redrawn filtered table, otherwise navigate to that page */
      if (tabl.rows({ page: 'current' })[0].indexOf(toprow) === -1) {
        tabl.page(tabl.rows()[0].indexOf(toprow) / tabl.page.info().length).draw('page')
      }
    } else {
      /* if filter is not active, activate filtering */
      $(this).parent().parent().find('button.active').removeClass('active')
      $(this).addClass('active')

      /* which rows are currently visible */
      var visibleRows = $(tabl.rows({ page: 'current' }).nodes())
      var rowIndices = tabl.rows({ page: 'current' })[0]

      /* loop through rows and find first filter-matching value */
      for (i = 0; i < visibleRows.length; i++) {
        if ($(visibleRows[i]).hasClass(ClickedId.replace('filter-',''))) {
          /* take index of filter-matching row */
          var toprow = rowIndices[i]
          hiddenRow.hideRows = rowIndices[i]

          /* stop looping */
          break
        }
      }

      /* actual filtering and table re-draw */
      $.fn.dataTable.ext.search.pop()
      $.fn.dataTable.ext.search.push(
        function(settings, data, dataIndex) {
          if (settings.nTable.id === 'original') {
            return $(tabl.row(dataIndex).node()).hasClass(ClickedId.replace('filter-','')) ? true : false;
          }
          else {
            return true
          }
        }
      )
      tabl.draw()

      /* check if table is empty or not and update top row indice */
      if (!tabl.rows({ page: 'current' })[0][0]) {
        var toprow = hiddenRow.hideRows
      } else if (!toprow) {
        /* if table has rows, but visible page before filtering did not contain any filter-matching rows, then take index of first row on whole table */
        var toprow = tabl.rows({ page: 'current' })[0][0]
      }

      /* check if filter-matching row is still on visible page, otherwise navigate to that page */
      if (tabl.rows({ page: 'current' })[0].indexOf(toprow) === -1) {
        tabl.page(tabl.rows({ search: 'applied' })[0].indexOf(toprow) / tabl.page.info().length).draw('page')
      }
    }

    /* remove focus from button due mouse click */
    $(this).blur()
  })
})






/* NEO4J visualisation */
/*
var viz;
function draw(id) {
*/
/* neo4j server configuration */
/*
  var config = {
    container_id: "graphdb-viz",
    server_url: "bolt://sonja.vsshp.net:7687",
*/
/* TODO: figure out how to obfuscate server credentials */
/*
    server_user: "neo4j",
    server_password: "password",
    labels: {
      "ObjectConcept": {
        "caption": "FSN",
        "size": "active",
        "community": "nodetype"
      }
    },
    relationships: {
      "ISA": {
        "thickness": "weight",
        "caption": false
      }
    },
*/
    /* TODO: decide what kind of relations are useful to display in a graph */
/*    initial_cypher: "MATCH (n:ObjectConcept {sctid:'" + id + "'})-[r:ISA]->(m)-[q:ISA]->(k) RETURN * LIMIT 100" */
    /*initial_cypher: "MATCH (n:ObjectConcept { sctid: " + id + "})-[r:ISA]->(m) RETURN * LIMIT 100"*/
    /*initial_cypher: "MATCH (n)-[r:ISA]->(m)-[q:ISA]->(k) RETURN * LIMIT 100"*/
/*  }; */

  /* update visualisation */
/*  viz = new NeoVis.default(config);
  viz.render()
}*/






/* visualisation clicking event */
/*
$("#graphdb-viz").on('click', function () {
  elem = $(this)
  console.log(elem)
*/
  /* TODO: figure out how to make graph clickable and clicking a node takes back to updated SNOMED-CT subpage */
  /*function getTooltip() {
    console.log(elem.find("div.vis-tooltip").html().match(/sctid.+\>+(.*)*?\<br\>/g))
  }
  setTimeout(getTooltip, 1000)*/

  //$(this).addClass("active").siblings().removeClass("active")
/*})*/

</script>

{% endblock %}
